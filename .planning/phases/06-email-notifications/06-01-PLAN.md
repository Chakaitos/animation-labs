---
phase: 06-email-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - lib/email/client.ts
  - lib/email/send.ts
  - emails/_components/EmailLayout.tsx
  - emails/video-ready.tsx
  - emails/payment-failed.tsx
  - supabase/migrations/00006_add_first_name.sql
  - lib/validations/auth.ts
  - components/auth/signup-form.tsx
  - lib/actions/auth.ts
  - .env.example
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery API"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify domain for production emails"
        location: "Resend Dashboard -> Domains -> Add Domain"
      - task: "Connect Resend to Supabase SMTP"
        location: "Supabase Dashboard -> Integrations -> Resend -> Connect"

must_haves:
  truths:
    - "Email templates render with Animation Labs branding"
    - "First name can be captured during signup"
    - "Resend client is configured and ready to send"
  artifacts:
    - path: "lib/email/client.ts"
      provides: "Resend client singleton"
      contains: "new Resend"
    - path: "lib/email/send.ts"
      provides: "Email send functions with retry"
      exports: ["sendVideoReadyEmail", "sendPaymentFailedEmail"]
    - path: "emails/video-ready.tsx"
      provides: "Video completion email template"
      contains: "VideoReadyEmail"
    - path: "emails/payment-failed.tsx"
      provides: "Payment failure email template"
      contains: "PaymentFailedEmail"
    - path: "emails/_components/EmailLayout.tsx"
      provides: "Shared email layout with branding"
      contains: "Animation Labs"
    - path: "supabase/migrations/00006_add_first_name.sql"
      provides: "First name column migration"
      contains: "first_name"
  key_links:
    - from: "lib/email/send.ts"
      to: "lib/email/client.ts"
      via: "import resend"
      pattern: "import.*resend.*from.*client"
    - from: "lib/email/send.ts"
      to: "emails/video-ready.tsx"
      via: "react email component"
      pattern: "VideoReadyEmail"
---

<objective>
Set up email infrastructure with Resend SDK, create branded React Email templates, and add first name capture for personalization.

Purpose: Enable personalized, branded transactional emails for video completion and payment failure notifications. The email system needs to be in place before integrating with existing webhooks.

Output: Resend client, send functions with retry logic, React Email templates for video-ready and payment-failed, and database migration for first_name field.
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-email-notifications/06-CONTEXT.md
@.planning/phases/06-email-notifications/06-RESEARCH.md

# Existing patterns to follow
@lib/stripe/client.ts
@app/api/webhooks/stripe/route.ts
@components/auth/signup-form.tsx
@lib/actions/auth.ts
@lib/validations/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install email dependencies and create Resend client</name>
  <files>
    package.json
    lib/email/client.ts
    .env.example
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install resend @react-email/components exponential-backoff
   npm install --save-dev @react-email/tailwind
   ```

2. Create `lib/email/client.ts`:
   - Export singleton Resend instance
   - Throw error if RESEND_API_KEY not set (same pattern as stripe/client.ts)
   - Use lazy initialization via Proxy to avoid build errors (same pattern as stripe client)

   ```typescript
   import { Resend } from 'resend'

   // Lazy-load client to avoid build errors when env vars not set
   export const resend = new Proxy({} as Resend, {
     get(_, prop) {
       if (!process.env.RESEND_API_KEY) {
         throw new Error('RESEND_API_KEY environment variable is not set')
       }
       const client = new Resend(process.env.RESEND_API_KEY)
       return client[prop as keyof Resend]
     },
   })
   ```

3. Update `.env.example`:
   - Uncomment RESEND_API_KEY line
   - Add comment about getting API key from Resend dashboard
  </action>
  <verify>
    Run `npm run build` - should compile without errors (client is lazy-loaded)
  </verify>
  <done>
    - resend, @react-email/components, exponential-backoff installed
    - lib/email/client.ts exports lazy Resend singleton
    - .env.example documents RESEND_API_KEY
  </done>
</task>

<task type="auto">
  <name>Task 2: Create React Email templates with shared layout</name>
  <files>
    emails/_components/EmailLayout.tsx
    emails/video-ready.tsx
    emails/payment-failed.tsx
  </files>
  <action>
1. Create `emails/_components/EmailLayout.tsx`:
   - Shared layout with Animation Labs branding
   - Logo header (use absolute URL: https://animationlabs.com/logo.svg for email clients)
   - Consistent footer with company name
   - Use Tailwind component from @react-email/tailwind for styling
   - Friendly, conversational wrapper

   Props: children, previewText (for email preview in inbox)

2. Create `emails/video-ready.tsx`:
   - Use EmailLayout wrapper
   - Props: firstName, brandName, videoUrl, thumbnailUrl
   - Friendly greeting: "Hey there, {firstName}!"
   - Main message: "Your {brandName} logo animation is ready to download."
   - Video thumbnail image
   - Prominent CTA button: "Download Your Video"
   - Timestamp: "Video created: {date}"
   - Default values for preview: firstName='there', brandName='Your Brand'

3. Create `emails/payment-failed.tsx`:
   - Use EmailLayout wrapper
   - Props: firstName, planName, amountDue (formatted), retryUrl
   - Friendly but urgent: "Hey {firstName}, there was a problem with your payment."
   - Clear explanation: payment for {planName} subscription failed
   - Amount due display
   - Prominent CTA button: "Update Payment Method"
   - Reassurance: credits still available until renewal date
   - Default values for preview

IMPORTANT: Use @react-email/components for all elements (Html, Head, Body, Container, Section, Heading, Text, Button, Img, Hr, Link). Wrap in Tailwind component for styling. Avoid flexbox/grid (use tables or stacking for layout).
  </action>
  <verify>
    Files exist at emails/_components/EmailLayout.tsx, emails/video-ready.tsx, emails/payment-failed.tsx. No TypeScript errors.
  </verify>
  <done>
    - EmailLayout provides consistent branding with logo header and footer
    - VideoReadyEmail template with thumbnail, download button, friendly tone
    - PaymentFailedEmail template with retry button, amount due, friendly urgency
    - All templates use @react-email/components for email client compatibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Create email send functions with retry logic</name>
  <files>
    lib/email/send.ts
  </files>
  <action>
Create `lib/email/send.ts` with two server-side send functions:

1. `sendVideoReadyEmail(userId: string, videoUrl: string, brandName: string, thumbnailUrl?: string)`:
   - Mark as 'use server'
   - Fetch user profile (email, first_name) from Supabase
   - Use backOff from exponential-backoff with:
     - numOfAttempts: 3 (per CONTEXT.md)
     - startingDelay: 1000 (1 second)
     - timeMultiple: 5 (1s -> 5s -> 25s)
     - jitter: 'full'
   - Send via resend.emails.send()
   - CRITICAL: Check result.error explicitly (Resend doesn't throw)
   - From: 'Animation Labs <noreply@animationlabs.com>'
   - Subject: `Your ${brandName} video is ready!`
   - Use VideoReadyEmail component
   - Log success with email ID
   - On permanent errors (invalid_email, domain_not_verified), don't retry

2. `sendPaymentFailedEmail(userId: string, planName: string, amountDue: number, retryUrl: string)`:
   - Same retry pattern
   - Fetch user profile
   - From: 'Animation Labs <noreply@animationlabs.com>'
   - Subject: 'Action Required: Payment failed for your Animation Labs subscription'
   - Use PaymentFailedEmail component
   - Format amountDue as currency (dollars, 2 decimal places)

Import pattern:
```typescript
'use server'

import { backOff } from 'exponential-backoff'
import { resend } from './client'
import { createClient } from '@/lib/supabase/server'
import VideoReadyEmail from '@/emails/video-ready'
import PaymentFailedEmail from '@/emails/payment-failed'
```

Error handling:
- Log all errors with context (emailType, userId)
- Re-throw after max retries for caller to handle
- Don't retry on validation errors (email format, domain issues)
  </action>
  <verify>
    TypeScript compiles without errors. Functions are exported and callable.
  </verify>
  <done>
    - sendVideoReadyEmail fetches user, sends branded email with retry
    - sendPaymentFailedEmail fetches user, sends urgent email with retry
    - Both handle Resend errors explicitly (check result.error)
    - 3 retries with exponential backoff (1s, 5s, 25s)
  </done>
</task>

<task type="auto">
  <name>Task 4: Add first_name to profiles and signup flow</name>
  <files>
    supabase/migrations/00006_add_first_name.sql
    lib/validations/auth.ts
    components/auth/signup-form.tsx
    lib/actions/auth.ts
  </files>
  <action>
1. Create `supabase/migrations/00006_add_first_name.sql`:
   ```sql
   -- Add first_name column for email personalization
   -- Phase 6: Email Notifications

   ALTER TABLE public.profiles
   ADD COLUMN first_name text;

   COMMENT ON COLUMN public.profiles.first_name IS 'User first name for email personalization';

   -- Update handle_new_user trigger to populate first_name from metadata
   CREATE OR REPLACE FUNCTION public.handle_new_user()
   RETURNS trigger
   LANGUAGE plpgsql
   SECURITY DEFINER SET search_path = ''
   AS $$
   BEGIN
     INSERT INTO public.profiles (id, email, full_name, first_name)
     VALUES (
       new.id,
       new.email,
       new.raw_user_meta_data->>'full_name',
       new.raw_user_meta_data->>'first_name'
     );
     RETURN new;
   END;
   $$;
   ```

2. Update `lib/validations/auth.ts`:
   - Add firstName field to signupSchema
   - Required, min 1 char, max 50 chars
   - Update SignupFormValues type export

3. Update `components/auth/signup-form.tsx`:
   - Add firstName field to defaultValues
   - Add FormField for first name (before email field)
   - Label: "First Name"
   - Placeholder: "John"
   - Pass firstName in formData.append()

4. Update `lib/actions/auth.ts`:
   - In signUp function, get firstName from formData
   - Pass firstName in signUp options.data (user metadata):
     ```typescript
     options: {
       emailRedirectTo: `${siteUrl}/auth/confirm`,
       data: {
         first_name: formData.get('firstName') as string,
       },
     },
     ```
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors. Migration file exists. Signup form has first name field.
  </verify>
  <done>
    - Migration adds first_name column to profiles
    - Trigger updated to populate first_name from user metadata
    - Signup validation requires first name
    - Signup form captures first name
    - Auth action passes first_name to Supabase metadata
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npx tsc --noEmit` passes
3. All files created in correct locations:
   - lib/email/client.ts
   - lib/email/send.ts
   - emails/_components/EmailLayout.tsx
   - emails/video-ready.tsx
   - emails/payment-failed.tsx
   - supabase/migrations/00006_add_first_name.sql
4. Signup form shows first name field
5. .env.example has RESEND_API_KEY documented
</verification>

<success_criteria>
- Resend client configured with lazy loading (avoids build errors)
- Email templates render with Animation Labs branding
- Send functions have 3-retry exponential backoff
- First name field added to signup flow and database
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-email-notifications/06-01-SUMMARY.md`
</output>
