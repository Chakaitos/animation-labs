---
phase: 06-email-notifications
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/api/webhooks/video-status/route.ts
  - app/api/webhooks/stripe/route.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User receives email when video completes"
    - "User receives email when payment fails"
    - "Duplicate webhooks do not send duplicate emails"
  artifacts:
    - path: "app/api/webhooks/video-status/route.ts"
      provides: "Video completion email trigger"
      contains: "sendVideoReadyEmail"
    - path: "app/api/webhooks/stripe/route.ts"
      provides: "Payment failed email trigger"
      contains: "sendPaymentFailedEmail"
  key_links:
    - from: "app/api/webhooks/video-status/route.ts"
      to: "lib/email/send.ts"
      via: "import sendVideoReadyEmail"
      pattern: "sendVideoReadyEmail"
    - from: "app/api/webhooks/stripe/route.ts"
      to: "lib/email/send.ts"
      via: "import sendPaymentFailedEmail"
      pattern: "sendPaymentFailedEmail"
---

<objective>
Integrate email sending into existing webhooks so users receive notifications when videos complete and payments fail.

Purpose: Wire the email infrastructure to actual application events. Video completion emails drive engagement (users download their videos), payment failure emails prevent churn (users update payment before cancellation).

Output: Updated video-status and Stripe webhooks that send emails on relevant events.
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-email-notifications/06-CONTEXT.md
@.planning/phases/06-email-notifications/06-RESEARCH.md
@.planning/phases/06-email-notifications/06-01-SUMMARY.md

# Files to modify
@app/api/webhooks/video-status/route.ts
@app/api/webhooks/stripe/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate video completion email into video-status webhook</name>
  <files>
    app/api/webhooks/video-status/route.ts
  </files>
  <action>
Modify `app/api/webhooks/video-status/route.ts` to send email when video completes:

1. Add import at top:
   ```typescript
   import { sendVideoReadyEmail } from '@/lib/email/send'
   ```

2. After successful status update to 'completed', send email:
   - Only send if status changed TO 'completed' (not if already completed)
   - Use the atomic update check already in place (if no rows updated, it was duplicate)
   - Get user_id and brand_name from the video record

3. Modify the update query to return more fields:
   ```typescript
   const { data, error } = await query.select('id, status, user_id, brand_name, video_url, thumbnail_url')
   ```

4. After successful update, send email (fire-and-forget with logging):
   ```typescript
   if (data && data.length > 0 && status === 'completed') {
     const video = data[0]
     // Send email asynchronously - don't block webhook response
     sendVideoReadyEmail(
       video.user_id,
       video.video_url || videoUrl,
       video.brand_name,
       video.thumbnail_url || thumbnailUrl
     ).catch(err => {
       console.error('Failed to send video ready email:', err)
       // Don't throw - email failure shouldn't fail the webhook
     })
   }
   ```

IMPORTANT: Email send is fire-and-forget. Webhook should return immediately (n8n has timeouts). Email has its own retry logic.

The existing idempotency check (only update if status not already completed) prevents duplicate emails automatically.
  </action>
  <verify>
    `npm run build` succeeds. Webhook route compiles without errors.
  </verify>
  <done>
    - Video-status webhook imports sendVideoReadyEmail
    - Email sent only when status changes to 'completed'
    - Duplicate webhooks don't send duplicate emails (existing idempotency)
    - Email errors logged but don't fail webhook
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate payment failed email into Stripe webhook</name>
  <files>
    app/api/webhooks/stripe/route.ts
  </files>
  <action>
Modify `app/api/webhooks/stripe/route.ts` to send email on payment failure:

1. Add import at top:
   ```typescript
   import { sendPaymentFailedEmail } from '@/lib/email/send'
   ```

2. Update `handlePaymentFailed` function:
   ```typescript
   async function handlePaymentFailed(invoice: Stripe.Invoice) {
     const subscriptionId = typeof (invoice as any).subscription === 'string'
       ? (invoice as any).subscription
       : (invoice as any).subscription?.id

     if (!subscriptionId) return

     // Update subscription status
     await getSupabaseAdmin()
       .from('subscriptions')
       .update({ status: 'past_due' })
       .eq('stripe_subscription_id', subscriptionId)

     // Get subscription details for email
     const { data: sub } = await getSupabaseAdmin()
       .from('subscriptions')
       .select('id, user_id, plan')
       .eq('stripe_subscription_id', subscriptionId)
       .single()

     if (sub) {
       // Get plan name for email
       const planId = sub.plan as keyof typeof PLANS
       const plan = PLANS[planId]
       const planName = plan?.name || 'your subscription'

       // Get amount due (convert cents to dollars)
       const amountDue = (invoice.amount_due || 0) / 100

       // Get retry URL (Stripe hosted invoice page)
       const retryUrl = invoice.hosted_invoice_url || 'https://animationlabs.com/billing'

       // Send email (fire-and-forget)
       sendPaymentFailedEmail(
         sub.user_id,
         planName,
         amountDue,
         retryUrl
       ).catch(err => {
         console.error('Failed to send payment failed email:', err)
       })
     }

     console.log(`Payment failed for subscription: ${subscriptionId}`)
   }
   ```

IMPORTANT:
- The webhook_events idempotency check at the top of POST handler prevents duplicate processing
- Email send is fire-and-forget (don't block webhook response)
- Use hosted_invoice_url from Stripe for retry link (customer can update payment there)
  </action>
  <verify>
    `npm run build` succeeds. Webhook route compiles without errors.
  </verify>
  <done>
    - Stripe webhook imports sendPaymentFailedEmail
    - handlePaymentFailed sends email after updating status
    - Email includes plan name, amount due, retry URL
    - Duplicate webhook events don't send duplicate emails (existing idempotency)
    - Email errors logged but don't fail webhook
  </done>
</task>

<task type="auto">
  <name>Task 3: Add email preview script to package.json</name>
  <files>
    package.json
  </files>
  <action>
Add email development script to package.json for template preview:

```json
{
  "scripts": {
    "dev": "next dev --turbo",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "email:dev": "email dev --dir emails --port 3001"
  }
}
```

The `email dev` command comes from the react-email package (installed as @react-email/components installs it as peer dependency).

Note: If react-email CLI not available, install explicitly:
```bash
npm install --save-dev react-email
```

This allows running `npm run email:dev` to preview email templates at http://localhost:3001.
  </action>
  <verify>
    `npm run email:dev` starts preview server (or reports react-email CLI needed)
  </verify>
  <done>
    - package.json has email:dev script
    - Can preview email templates during development
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npx tsc --noEmit` passes
3. video-status webhook has sendVideoReadyEmail import and call
4. Stripe webhook has sendPaymentFailedEmail import and call
5. package.json has email:dev script
</verification>

<success_criteria>
- Video completion triggers email notification
- Payment failure triggers email notification
- Emails don't block webhook responses (fire-and-forget)
- Duplicate webhooks don't send duplicate emails
- Email preview available via npm run email:dev
</success_criteria>

<output>
After completion, create `.planning/phases/06-email-notifications/06-02-SUMMARY.md`
</output>
