---
phase: 06-email-notifications
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Verification email arrives after signup"
    - "Password reset email arrives with working link"
    - "Video completion email arrives with download button"
    - "Payment failure email arrives with retry button"
  artifacts: []
  key_links: []
---

<objective>
Verify all email notification flows work end-to-end with real email delivery.

Purpose: Confirm that users will actually receive emails at the right moments. This requires Resend API key configured and Supabase SMTP connected. Testing catches issues before users encounter them.

Output: Verification that all 4 email types are deliverable and functional.
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-email-notifications/06-CONTEXT.md
@.planning/phases/06-email-notifications/06-01-SUMMARY.md
@.planning/phases/06-email-notifications/06-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Verify email configuration and all flows</name>
  <what-built>
Complete email notification system:
- Resend client with retry logic
- Branded React Email templates (video-ready, payment-failed)
- First name capture in signup flow
- Video completion email trigger in video-status webhook
- Payment failure email trigger in Stripe webhook
- Supabase SMTP configured with Resend (for auth emails)
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Set RESEND_API_KEY in .env.local (get from Resend Dashboard -> API Keys)
2. Connect Resend to Supabase SMTP:
   - Go to Supabase Dashboard -> Integrations -> Resend -> Connect
   - OR manually configure SMTP in Supabase Auth settings
3. Run database migration: Apply 00006_add_first_name.sql via Supabase Dashboard SQL editor

**Test 1: Email Preview (Local)**
1. Run `npm run email:dev`
2. Open http://localhost:3001
3. Verify video-ready.tsx and payment-failed.tsx templates render with branding
4. Expected: AnimateLabs logo visible, friendly tone, CTA buttons styled

**Test 2: Signup with First Name**
1. Start dev server: `npm run dev`
2. Go to http://localhost:3000/signup
3. Verify first name field appears (before email)
4. Create new account with all fields
5. Expected: Redirects to /verify-email page

**Test 3: Verification Email (Supabase Auth)**
1. Check inbox of signup email
2. Expected: Verification email arrives (sent via Resend SMTP)
3. Click verification link
4. Expected: Account verified, can log in

**Test 4: Password Reset Email (Supabase Auth)**
1. Go to http://localhost:3000/reset-password
2. Enter email, submit
3. Check inbox
4. Expected: Password reset email arrives with secure link
5. Click link, set new password
6. Expected: Password updated, can log in

**Test 5: Video Completion Email (Application)**
1. Log in as user with credits
2. Create a video (or use existing processing video)
3. Simulate n8n callback (or wait for actual completion):
   ```bash
   curl -X POST http://localhost:3000/api/webhooks/video-status \
     -H "Content-Type: application/json" \
     -H "x-webhook-secret: YOUR_N8N_SECRET" \
     -d '{"videoId": "VIDEO_UUID", "status": "completed", "videoUrl": "https://example.com/video.mp4"}'
   ```
4. Check inbox
5. Expected: "Your [BrandName] video is ready!" email with:
   - Friendly greeting with first name
   - Download button
   - AnimateLabs branding

**Test 6: Payment Failed Email (Application)**
1. This requires triggering a Stripe invoice.payment_failed event
2. Option A: Use Stripe CLI to trigger test event:
   ```bash
   stripe trigger invoice.payment_failed
   ```
3. Option B: Skip if no test environment configured
4. Expected: "Action Required: Payment failed" email with:
   - Amount due
   - Retry button
   - AnimateLabs branding

**Minimum for approval:**
- Tests 1-5 pass (email preview, signup, verification, reset, video-ready)
- Test 6 is optional (payment failure) - can verify in production
  </how-to-verify>
  <resume-signal>
Type "approved" when email flows verified, or describe any issues found
  </resume-signal>
</task>

</tasks>

<verification>
All email flows tested:
1. Email preview renders correctly
2. Signup captures first name
3. Verification email delivered
4. Password reset email delivered
5. Video completion email delivered
6. Payment failure email delivered (optional)
</verification>

<success_criteria>
- User can see email templates in preview
- User receives verification email after signup
- User receives password reset email when requested
- User receives video completion email when video finishes
- All emails have AnimateLabs branding and friendly tone
</success_criteria>

<output>
After completion, create `.planning/phases/06-email-notifications/06-03-SUMMARY.md`
</output>
