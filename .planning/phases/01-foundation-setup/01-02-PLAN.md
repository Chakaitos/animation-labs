---
phase: 01-foundation-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - lib/supabase/client.ts
  - lib/supabase/server.ts
  - middleware.ts
autonomous: true

must_haves:
  truths:
    - "Browser client can be imported in 'use client' components"
    - "Server client can be imported in Server Components"
    - "Middleware refreshes expired auth tokens automatically"
  artifacts:
    - path: "lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createClient"]
      contains: "createBrowserClient"
    - path: "lib/supabase/server.ts"
      provides: "Server Supabase client"
      exports: ["createClient"]
      contains: "createServerClient"
    - path: "middleware.ts"
      provides: "Auth token refresh middleware"
      exports: ["middleware", "config"]
      contains: "supabase.auth.getUser"
  key_links:
    - from: "lib/supabase/client.ts"
      to: "@supabase/ssr"
      via: "createBrowserClient import"
      pattern: "import.*createBrowserClient.*@supabase/ssr"
    - from: "lib/supabase/server.ts"
      to: "next/headers"
      via: "cookies import"
      pattern: "import.*cookies.*next/headers"
    - from: "middleware.ts"
      to: "lib/supabase"
      via: "Supabase client creation inline"
      pattern: "createServerClient"
---

<objective>
Set up Supabase client utilities for both client and server components, plus middleware for automatic auth token refresh.

Purpose: Create the SSR-compatible Supabase integration layer that authentication and data access will use.
Output: Three files - client.ts for browser, server.ts for server components, middleware.ts for token refresh.
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-setup/01-RESEARCH.md
@.planning/phases/01-foundation-setup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase client utilities</name>
  <files>
    lib/supabase/client.ts
    lib/supabase/server.ts
  </files>
  <action>
Create `lib/supabase/client.ts` for Client Components (browser):

```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

Create `lib/supabase/server.ts` for Server Components:

```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // Server Component can't set cookies - this is expected
            // The middleware handles token refresh
          }
        },
      },
    }
  )
}
```

**Important notes:**
- The server.ts function is `async` because `cookies()` is async in Next.js 16
- The try/catch in setAll is expected - Server Components can read but not write cookies
- Both files export `createClient` but they use different underlying implementations

**WHY separate files:**
- Client Components need `createBrowserClient` which uses browser APIs
- Server Components need `createServerClient` which uses Next.js `cookies()`
- Mixing them causes hydration errors or runtime failures
  </action>
  <verify>
Run TypeScript compilation: `npx tsc --noEmit`
Verify both files exist:
- `lib/supabase/client.ts`
- `lib/supabase/server.ts`
  </verify>
  <done>
Supabase client utilities created for both browser and server contexts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth middleware for token refresh</name>
  <files>
    middleware.ts
  </files>
  <action>
Create `middleware.ts` in the project root (NOT in app/ directory):

```typescript
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value)
          )
          supabaseResponse = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // IMPORTANT: This refreshes the session if expired
  // Do not remove this line - it's the whole point of the middleware
  await supabase.auth.getUser()

  return supabaseResponse
}

export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - images and other static assets
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

**Why this middleware is REQUIRED:**
1. Server Components cannot write cookies
2. When a JWT expires, Supabase needs to refresh it and update the cookie
3. Middleware runs before Server Components and CAN write cookies
4. The `getUser()` call triggers token refresh if needed
5. Without this, users get randomly logged out when their token expires

**Important:** The middleware creates its own Supabase client inline rather than importing from lib/supabase because middleware has special requirements for cookie handling.
  </action>
  <verify>
Run `npm run dev` - middleware should not cause errors.
File `middleware.ts` exists in project root.
No TypeScript errors: `npx tsc --noEmit`
  </verify>
  <done>
Auth middleware created. Token refresh happens automatically on every request.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Supabase setup compiles and exports work</name>
  <files>
    app/page.tsx
  </files>
  <action>
Update `app/page.tsx` to verify the Supabase server client can be imported and used (even without real credentials it should compile):

```typescript
import { createClient } from '@/lib/supabase/server'

export default async function Home() {
  // This verifies the import works - will fail at runtime without real credentials
  // but should compile without errors
  // Uncomment when Supabase project is configured:
  // const supabase = await createClient()
  // const { data: { user } } = await supabase.auth.getUser()

  return (
    <main className="flex min-h-screen flex-col items-center justify-center p-24">
      <h1 className="text-4xl font-bold mb-4">AnimateLabs</h1>
      <p className="text-muted-foreground">
        Professional logo animations in minutes
      </p>
    </main>
  )
}
```

This minimal update:
1. Imports the server client (verifies path works)
2. Shows a simple landing message
3. Uses Tailwind classes (verifies CSS works)
4. Comments out actual Supabase usage until credentials are set

The commented code is intentional documentation - shows HOW to use the client.
  </action>
  <verify>
Run `npm run dev` - page loads without errors.
Run `npx tsc --noEmit` - no TypeScript errors.
Visit http://localhost:3000 - page shows "AnimateLabs" heading.
  </verify>
  <done>
Supabase integration verified. Imports work, TypeScript compiles, page renders.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Development server runs: `npm run dev`
3. File structure exists:
   - `lib/supabase/client.ts` - exports createClient
   - `lib/supabase/server.ts` - exports createClient (async)
   - `middleware.ts` - exports middleware and config
4. Homepage loads with "AnimateLabs" text
5. No console errors in browser or terminal
</verification>

<success_criteria>
- Supabase client utilities created for browser and server
- Middleware handles auth token refresh
- TypeScript compilation passes
- Dev server runs without errors
- Integration is ready for use once Supabase credentials are added
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-setup/01-02-SUMMARY.md` using the summary template.
</output>
