---
phase: 01-foundation-setup
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/migrations/00001_initial_schema.sql
  - CLAUDE.md
autonomous: true

user_setup:
  - service: supabase
    why: "Database and authentication backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard > Settings > API > Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard > Settings > API > anon public key"
    dashboard_config:
      - task: "Create Supabase project"
        location: "https://app.supabase.com > New Project"
      - task: "Run migration SQL"
        location: "Supabase Dashboard > SQL Editor > paste and run migration"

must_haves:
  truths:
    - "Database schema SQL is version-controlled"
    - "All tables have RLS enabled"
    - "Profile auto-creation trigger exists"
    - "CLAUDE.md documents project conventions"
  artifacts:
    - path: "supabase/migrations/00001_initial_schema.sql"
      provides: "Database schema definition"
      contains: "create table public.profiles"
      min_lines: 100
    - path: "CLAUDE.md"
      provides: "Project conventions documentation"
      contains: "Project Structure"
      min_lines: 30
  key_links:
    - from: "supabase/migrations/00001_initial_schema.sql"
      to: "auth.users"
      via: "Foreign key references"
      pattern: "references auth\\.users"
---

<objective>
Create the database migration file with complete schema (profiles, subscriptions, credit_transactions, videos) and RLS policies. Update CLAUDE.md with project conventions.

Purpose: Establish the data model and security rules. Document conventions for future development.
Output: Version-controlled SQL migration and updated project documentation.
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-setup/01-RESEARCH.md
@.planning/phases/01-foundation-setup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration file</name>
  <files>
    supabase/migrations/00001_initial_schema.sql
  </files>
  <action>
Create the directory structure and migration file:

```bash
mkdir -p supabase/migrations
```

Create `supabase/migrations/00001_initial_schema.sql` with the complete schema:

```sql
-- AnimateLabs Initial Schema
-- Created: Phase 1 - Foundation & Setup
--
-- This migration creates the core tables for AnimateLabs:
-- - profiles: User profile data (extends auth.users)
-- - subscriptions: Credit-based subscription plans
-- - credit_transactions: Audit trail for credit usage
-- - videos: Generated logo animation videos
--
-- All tables have Row-Level Security (RLS) enabled.
-- Users can only access their own data.

-- ============================================
-- PROFILES TABLE
-- ============================================
-- Extends auth.users with application-specific fields

create table public.profiles (
  id uuid not null references auth.users on delete cascade,
  email text not null,
  full_name text,
  avatar_url text,
  created_at timestamptz default now() not null,
  updated_at timestamptz default now() not null,
  primary key (id)
);

comment on table public.profiles is 'User profile information extending auth.users';

-- ============================================
-- SUBSCRIPTIONS TABLE
-- ============================================
-- Tracks user subscriptions and credit balances

create table public.subscriptions (
  id uuid default gen_random_uuid() primary key,
  user_id uuid not null references auth.users on delete cascade,
  plan text not null check (plan in ('starter', 'professional')),
  status text not null default 'active' check (status in ('active', 'cancelled', 'past_due', 'expired')),
  credits_remaining int not null default 0 check (credits_remaining >= 0),
  credits_total int not null check (credits_total >= 0),
  stripe_customer_id text,
  stripe_subscription_id text unique,
  current_period_start timestamptz,
  current_period_end timestamptz,
  created_at timestamptz default now() not null,
  updated_at timestamptz default now() not null
);

comment on table public.subscriptions is 'User subscription plans with credit tracking';
comment on column public.subscriptions.plan is 'Subscription tier: starter or professional';
comment on column public.subscriptions.credits_remaining is 'Credits available in current period';
comment on column public.subscriptions.credits_total is 'Total credits allocated for this period';

-- ============================================
-- CREDIT TRANSACTIONS TABLE
-- ============================================
-- Audit trail for all credit movements

create table public.credit_transactions (
  id uuid default gen_random_uuid() primary key,
  user_id uuid not null references auth.users on delete cascade,
  subscription_id uuid references public.subscriptions on delete set null,
  video_id uuid, -- Will reference videos table after it's created
  amount int not null, -- positive = credit added, negative = credit used
  type text not null check (type in ('subscription', 'purchase', 'usage', 'refund', 'bonus', 'expiry')),
  description text,
  created_at timestamptz default now() not null
);

comment on table public.credit_transactions is 'Audit log of all credit additions and deductions';
comment on column public.credit_transactions.amount is 'Positive for credits added, negative for credits used';
comment on column public.credit_transactions.type is 'Transaction type: subscription (monthly grant), purchase (credit pack), usage (video created), refund, bonus, expiry';

-- ============================================
-- VIDEOS TABLE
-- ============================================
-- Generated logo animation videos

create table public.videos (
  id uuid default gen_random_uuid() primary key,
  user_id uuid not null references auth.users on delete cascade,
  brand_name text not null,
  status text not null default 'pending' check (status in ('pending', 'processing', 'completed', 'failed')),
  logo_url text,
  video_url text,
  thumbnail_url text,
  credits_used int not null default 1 check (credits_used >= 0),
  duration_seconds int check (duration_seconds > 0),
  quality text check (quality in ('720p', '1080p', '4k')),
  style text,
  primary_color text,
  secondary_color text,
  creative_direction text,
  error_message text,
  n8n_execution_id text,
  metadata jsonb default '{}'::jsonb,
  created_at timestamptz default now() not null,
  updated_at timestamptz default now() not null
);

comment on table public.videos is 'Logo animation videos created by users';
comment on column public.videos.status is 'Video processing status: pending (queued), processing (in n8n), completed, failed';
comment on column public.videos.metadata is 'Additional metadata from n8n workflow (JSON)';

-- Add foreign key from credit_transactions to videos
alter table public.credit_transactions
  add constraint credit_transactions_video_id_fkey
  foreign key (video_id) references public.videos(id) on delete set null;

-- ============================================
-- INDEXES
-- ============================================

create index profiles_email_idx on public.profiles(email);
create index subscriptions_user_id_idx on public.subscriptions(user_id);
create index subscriptions_status_idx on public.subscriptions(status);
create index subscriptions_stripe_customer_idx on public.subscriptions(stripe_customer_id);
create index credit_transactions_user_id_idx on public.credit_transactions(user_id);
create index credit_transactions_created_at_idx on public.credit_transactions(created_at desc);
create index videos_user_id_idx on public.videos(user_id);
create index videos_status_idx on public.videos(status);
create index videos_created_at_idx on public.videos(created_at desc);

-- ============================================
-- ROW LEVEL SECURITY
-- ============================================

-- Enable RLS on all tables
alter table public.profiles enable row level security;
alter table public.subscriptions enable row level security;
alter table public.credit_transactions enable row level security;
alter table public.videos enable row level security;

-- Profiles policies
create policy "Users can view own profile"
  on public.profiles for select
  using (auth.uid() = id);

create policy "Users can update own profile"
  on public.profiles for update
  using (auth.uid() = id);

-- Subscriptions policies (read-only for users - writes via server/webhook)
create policy "Users can view own subscriptions"
  on public.subscriptions for select
  using (auth.uid() = user_id);

-- Credit transactions policies (read-only for users - writes via server)
create policy "Users can view own credit transactions"
  on public.credit_transactions for select
  using (auth.uid() = user_id);

-- Videos policies
create policy "Users can view own videos"
  on public.videos for select
  using (auth.uid() = user_id);

create policy "Users can insert own videos"
  on public.videos for insert
  with check (auth.uid() = user_id);

create policy "Users can update own videos"
  on public.videos for update
  using (auth.uid() = user_id);

create policy "Users can delete own videos"
  on public.videos for delete
  using (auth.uid() = user_id);

-- ============================================
-- FUNCTIONS & TRIGGERS
-- ============================================

-- Auto-populate profile on user signup
create or replace function public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = ''
as $$
begin
  insert into public.profiles (id, email, full_name)
  values (
    new.id,
    new.email,
    new.raw_user_meta_data->>'full_name'
  );
  return new;
end;
$$;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- Auto-update updated_at timestamp
create or replace function public.handle_updated_at()
returns trigger
language plpgsql
as $$
begin
  new.updated_at = now();
  return new;
end;
$$;

create trigger profiles_updated_at
  before update on public.profiles
  for each row execute procedure public.handle_updated_at();

create trigger subscriptions_updated_at
  before update on public.subscriptions
  for each row execute procedure public.handle_updated_at();

create trigger videos_updated_at
  before update on public.videos
  for each row execute procedure public.handle_updated_at();

-- ============================================
-- HELPER FUNCTIONS
-- ============================================

-- Check if user has sufficient credits
create or replace function public.check_credits(p_user_id uuid, p_required int default 1)
returns boolean
language plpgsql
security definer
as $$
declare
  v_credits_remaining int;
begin
  select credits_remaining into v_credits_remaining
  from public.subscriptions
  where user_id = p_user_id
    and status = 'active'
    and (current_period_end is null or current_period_end > now())
  order by created_at desc
  limit 1;

  return coalesce(v_credits_remaining, 0) >= p_required;
end;
$$;

-- Deduct credits (used by server when creating video)
create or replace function public.deduct_credits(
  p_user_id uuid,
  p_video_id uuid,
  p_credits int default 1,
  p_description text default 'Video creation'
)
returns boolean
language plpgsql
security definer
as $$
declare
  v_subscription_id uuid;
  v_credits_remaining int;
begin
  -- Get active subscription with sufficient credits
  select id, credits_remaining into v_subscription_id, v_credits_remaining
  from public.subscriptions
  where user_id = p_user_id
    and status = 'active'
    and (current_period_end is null or current_period_end > now())
    and credits_remaining >= p_credits
  order by created_at desc
  limit 1
  for update; -- Lock the row

  if v_subscription_id is null then
    return false;
  end if;

  -- Deduct credits
  update public.subscriptions
  set credits_remaining = credits_remaining - p_credits
  where id = v_subscription_id;

  -- Record transaction
  insert into public.credit_transactions (user_id, subscription_id, video_id, amount, type, description)
  values (p_user_id, v_subscription_id, p_video_id, -p_credits, 'usage', p_description);

  return true;
end;
$$;

-- Grant credits (used by server when subscription renews)
create or replace function public.grant_credits(
  p_user_id uuid,
  p_subscription_id uuid,
  p_credits int,
  p_type text default 'subscription',
  p_description text default 'Subscription credits'
)
returns boolean
language plpgsql
security definer
as $$
begin
  -- Update subscription credits
  update public.subscriptions
  set credits_remaining = credits_remaining + p_credits,
      credits_total = credits_total + p_credits
  where id = p_subscription_id
    and user_id = p_user_id;

  if not found then
    return false;
  end if;

  -- Record transaction
  insert into public.credit_transactions (user_id, subscription_id, amount, type, description)
  values (p_user_id, p_subscription_id, p_credits, p_type, p_description);

  return true;
end;
$$;
```

**Schema design notes:**
- `profiles`: Extends auth.users (auto-created on signup via trigger)
- `subscriptions`: Credit-based plans with Stripe integration fields
- `credit_transactions`: Full audit trail of all credit movements
- `videos`: All video creation parameters and results

**Security:**
- RLS enabled on ALL tables
- Users can only see their own data
- Write operations on sensitive tables (subscriptions, credits) done via SECURITY DEFINER functions
- Profile auto-created via trigger to prevent orphan users
  </action>
  <verify>
File exists: `supabase/migrations/00001_initial_schema.sql`
File contains all four tables and RLS policies.
SQL syntax is valid (no obvious errors).
  </verify>
  <done>
Database migration created with profiles, subscriptions, credit_transactions, and videos tables. RLS enabled on all tables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLAUDE.md with project conventions</name>
  <files>
    CLAUDE.md
  </files>
  <action>
Update the existing `CLAUDE.md` with comprehensive project documentation:

```markdown
# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

AnimateLabs — Professional logo animation SaaS delivering videos in 10-15 minutes at $3-5 per video.

**Stack:** Next.js 16, TypeScript, Tailwind CSS 4, shadcn/ui, Supabase, Stripe, n8n, Resend

## Required Skills

Use these skills at the appropriate times:

| Skill | When to Use |
|-------|-------------|
| `frontend-design` | When building ANY UI components, pages, or visual elements |
| `llm-application-dev:prompt-engineer` | When generating/optimizing prompts for n8n workflows |
| `backend-development:api-design-principles` | When designing ANY API endpoints or routes |
| `n8n-mcp-skills:*` | When fixing, troubleshooting, or updating n8n workflows |

## Project Structure

```
animatelabs/
├── app/                    # Next.js App Router
│   ├── layout.tsx         # Root layout
│   ├── page.tsx           # Home page
│   ├── globals.css        # Global styles + Tailwind
│   └── (routes)/          # Route groups (to be added)
├── components/            # React components
│   └── ui/                # shadcn/ui components
├── lib/                   # Utilities
│   ├── supabase/          # Supabase clients
│   │   ├── client.ts      # Browser client (use in 'use client')
│   │   └── server.ts      # Server client (use in Server Components)
│   └── utils.ts           # shadcn/ui utilities (cn function)
├── supabase/              # Database
│   └── migrations/        # SQL migrations
├── middleware.ts          # Auth token refresh
├── .env.example           # Env var template (committed)
└── .env.local             # Local secrets (gitignored)
```

## Commands

```bash
# Development
npm run dev          # Start dev server (Turbopack)
npm run build        # Production build
npm run start        # Start production server
npm run lint         # Run ESLint

# shadcn/ui
npx shadcn@latest add [component]  # Add component

# Type checking
npx tsc --noEmit     # Check types without emitting
```

## Conventions

### File Naming
- Components: PascalCase (`UserProfile.tsx`)
- Utilities: camelCase (`formatDate.ts`)
- Routes: kebab-case folders (`app/create-video/page.tsx`)

### Supabase Usage
- **Client Components:** Import from `@/lib/supabase/client`
- **Server Components:** Import from `@/lib/supabase/server` (async)
- **Never** mix client types — causes hydration errors

### Database
- All tables have RLS enabled
- User data access: `auth.uid() = user_id` pattern
- Credit operations: Use `deduct_credits()` and `grant_credits()` functions
- Schema changes: Add to `supabase/migrations/` (versioned)

### Components
- Use shadcn/ui components from `@/components/ui/`
- Custom components go in `@/components/`
- Prefer Server Components; use `'use client'` only when needed

### Environment Variables
- `NEXT_PUBLIC_*`: Safe for client (browser accessible)
- Without prefix: Server-only (never exposed)
- Add new vars to both `.env.example` and `.env.local`

## Database Schema

### Tables
- `profiles`: User profile (auto-created on signup)
- `subscriptions`: Credit-based plans, Stripe integration
- `credit_transactions`: Audit trail for credits
- `videos`: Logo animation videos

### Key Functions
- `check_credits(user_id, required)`: Check if user has enough credits
- `deduct_credits(user_id, video_id, credits)`: Deduct credits for video
- `grant_credits(user_id, subscription_id, credits)`: Add credits

## External Services

| Service | Purpose | Env Vars |
|---------|---------|----------|
| Supabase | DB, Auth, Storage | `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY` |
| Stripe | Payments | `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`, `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET` |
| n8n | Video workflow | `N8N_WEBHOOK_URL`, `N8N_WEBHOOK_SECRET` |
| Resend | Email | `RESEND_API_KEY` |
```

This replaces the existing CLAUDE.md content with comprehensive documentation that will be useful throughout development.
  </action>
  <verify>
CLAUDE.md contains updated content.
Includes: Project Structure, Commands, Conventions, Database Schema sections.
  </verify>
  <done>
CLAUDE.md updated with comprehensive project conventions and documentation.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Migration file exists: `supabase/migrations/00001_initial_schema.sql`
2. Migration contains all tables: profiles, subscriptions, credit_transactions, videos
3. Migration has RLS policies for all tables
4. CLAUDE.md contains comprehensive project documentation
5. No uncommitted concerns or missing documentation
</verification>

<success_criteria>
- Database schema is version-controlled as SQL migration
- All tables have RLS enabled with appropriate policies
- Profile auto-creation trigger exists
- Helper functions for credit management exist
- CLAUDE.md documents project conventions
- Schema is ready to be run in Supabase SQL Editor
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-setup/01-03-SUMMARY.md` using the summary template.
</output>
