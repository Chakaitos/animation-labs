---
phase: 02-authentication-account
plan: 06
type: execute
wave: 5
depends_on: ["02-03", "02-04", "02-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can sign up with email and password"
    - "User receives verification email and can verify their account"
    - "User can log in and stay logged in across browser sessions"
    - "User can log out from any page"
    - "User can reset forgotten password via email link"
    - "User can change their password from account settings"
  artifacts: []
  key_links: []
---

<objective>
Verify all authentication flows work end-to-end with a real user test.

Purpose: All auth components and pages are implemented. This checkpoint ensures the complete authentication system works correctly before marking the phase complete. Catches integration issues between Supabase Auth, server actions, and UI.

Output: Verification of all 6 success criteria from Phase 2.
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-account/02-CONTEXT.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Verify complete authentication flow</name>
  <what-built>
Complete authentication system with:
- Sign up with email/password (/signup)
- Email verification via callback endpoint (/auth/confirm)
- Login with session persistence (/login)
- Logout from user menu
- Password reset request (/reset-password)
- Password update after reset (/update-password)
- Password change from settings (/account/settings)
- Protected routes (dashboard, settings) with auth redirects
  </what-built>
  <how-to-verify>
**STEP 0: Configure Supabase Email Templates (REQUIRED FIRST)**

Before starting the dev server or testing any email flows, verify your Supabase email templates are configured for PKCE/SSR flow:

1. Go to Supabase Dashboard > Authentication > Email Templates
2. For EACH of these templates (Confirm signup, Magic Link, Change Email, Reset Password):
   - Click "Edit" or "Source" to view the template HTML
   - Look for the confirmation link format

3. **CRITICAL CHECK:** The link MUST use `token_hash` format, NOT `ConfirmationURL`:

   **CORRECT (PKCE flow):**
   ```
   {{ .SiteURL }}/auth/confirm?token_hash={{ .TokenHash }}&type=email
   ```
   or for password reset:
   ```
   {{ .SiteURL }}/auth/confirm?token_hash={{ .TokenHash }}&type=recovery&next=/update-password
   ```

   **INCORRECT (implicit flow - will NOT work):**
   ```
   {{ .ConfirmationURL }}
   ```

4. If templates use `ConfirmationURL`, update them to use `token_hash` format:
   - For signup confirmation: `{{ .SiteURL }}/auth/confirm?token_hash={{ .TokenHash }}&type=email`
   - For password reset: `{{ .SiteURL }}/auth/confirm?token_hash={{ .TokenHash }}&type=recovery&next=/update-password`

5. Save any template changes before proceeding

**Why this matters:** The PKCE flow used in this SSR implementation requires `token_hash` verification via the `/auth/confirm` callback route. Default Supabase templates may use direct `ConfirmationURL` which bypasses this route and breaks authentication.

---

**STEP 1: Start Dev Server**

Start the dev server: `npm run dev`

---

**Test 1: Sign Up Flow (AUTH-01, AUTH-02)**
1. Visit http://localhost:3000/signup
2. Enter a valid email and password (8+ chars, uppercase, lowercase, number)
3. Click "Create Account"
4. Verify redirect to /verify-email page with instructions
5. Check your email for verification link from Supabase
6. Click the verification link
7. Verify redirect to /dashboard (you're now logged in)

**Test 2: Login and Session (AUTH-03)**
1. Visit http://localhost:3000/login
2. Enter credentials from Test 1
3. Click "Sign In"
4. Verify redirect to /dashboard
5. Close browser completely
6. Reopen and visit http://localhost:3000/dashboard
7. Verify still logged in (session persisted)

**Test 3: Logout (AUTH-04)**
1. While logged in, click avatar in top-right corner
2. Click "Sign out" in dropdown
3. Verify redirect to /login
4. Visit http://localhost:3000/dashboard
5. Verify redirect to /login (session cleared)

**Test 4: Password Reset (AUTH-05)**
1. Visit http://localhost:3000/reset-password
2. Enter your email
3. Click "Send Reset Link"
4. Verify success message appears (same for valid or invalid emails)
5. Check your email for reset link
6. Click the reset link
7. Verify redirect to /update-password
8. Enter new password (meeting requirements)
9. Click "Update Password"
10. Verify redirect to /login with "password updated" message
11. Log in with new password

**Test 5: Change Password (ACCT-01)**
1. Log in and visit http://localhost:3000/account/settings
2. Verify email is displayed (read-only)
3. Enter current password, new password, confirm new password
4. Click "Change Password"
5. Verify redirect to /login with "password changed" message
6. Log in with new password
7. (Optional) Try logging in from another device - should be logged out

**Expected Results:**
- STEP 0 completed (email templates configured)
- All 5 tests pass
- Toast notifications appear for errors (invalid email, wrong password, etc.)
- Password validation enforces 8 chars, uppercase, lowercase, number
- No console errors during testing
  </how-to-verify>
  <resume-signal>Type "verified" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Human verification of end-to-end authentication flows.
</verification>

<success_criteria>
All 6 phase success criteria verified:
1. User can sign up with email and password
2. User receives verification email and can verify their account
3. User can log in and stay logged in across browser sessions
4. User can log out from any page
5. User can reset forgotten password via email link
6. User can change their password from account settings
</success_criteria>

<output>
After verification passes, create `.planning/phases/02-authentication-account/02-06-SUMMARY.md` documenting test results.
</output>
