---
phase: 02-authentication-account
plan: 05
type: execute
wave: 4
depends_on: ["02-02", "02-03"]
files_modified:
  - components/auth/change-password-form.tsx
  - components/navigation/user-menu.tsx
  - app/(protected)/account/settings/page.tsx
  - app/(protected)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Authenticated user can access account settings page"
    - "User can change password from account settings"
    - "Password change forces logout on all devices"
    - "User menu appears in protected pages with logout option"
    - "Unauthenticated users are redirected to login"
  artifacts:
    - path: "components/auth/change-password-form.tsx"
      provides: "Password change form with current password verification"
      min_lines: 60
    - path: "components/navigation/user-menu.tsx"
      provides: "User dropdown menu with settings and logout"
      min_lines: 40
    - path: "app/(protected)/account/settings/page.tsx"
      provides: "Account settings page with password change"
    - path: "app/(protected)/dashboard/page.tsx"
      provides: "Dashboard placeholder with user menu"
  key_links:
    - from: "components/auth/change-password-form.tsx"
      to: "lib/actions/auth.ts"
      via: "changePassword server action call"
      pattern: "changePassword\\(formData\\)"
    - from: "components/navigation/user-menu.tsx"
      to: "lib/actions/auth.ts"
      via: "signOut server action call"
      pattern: "signOut\\(\\)"
    - from: "app/(protected)/account/settings/page.tsx"
      to: "supabase.auth.getUser"
      via: "authentication check"
      pattern: "getUser\\(\\)"
---

<objective>
Create account settings page with password change functionality and user menu with logout.

Purpose: Users need to change their password and sign out from any page. The account settings page displays user email (read-only) and a password change form. The user menu provides quick access to settings and logout from any protected page.

Output: Change password form, user menu component, account settings page, dashboard placeholder.
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-account/02-RESEARCH.md
@.planning/phases/02-authentication-account/02-01-SUMMARY.md
@.planning/phases/02-authentication-account/02-02-SUMMARY.md

@lib/validations/auth.ts
@lib/actions/auth.ts
@lib/supabase/server.ts
@components/ui/dropdown-menu.tsx
@components/ui/avatar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create change password form and account settings page</name>
  <files>components/auth/change-password-form.tsx, app/(protected)/account/settings/page.tsx</files>
  <action>
Create change password form at components/auth/change-password-form.tsx:

```typescript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { toast } from 'sonner'
import { changePassword } from '@/lib/actions/auth'
import { changePasswordSchema, type ChangePasswordFormValues } from '@/lib/validations/auth'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form'

export function ChangePasswordForm() {
  const [isLoading, setIsLoading] = useState(false)

  const form = useForm<ChangePasswordFormValues>({
    resolver: zodResolver(changePasswordSchema),
    defaultValues: {
      currentPassword: '',
      newPassword: '',
      confirmNewPassword: '',
    },
  })

  async function onSubmit(data: ChangePasswordFormValues) {
    setIsLoading(true)

    const formData = new FormData()
    formData.append('currentPassword', data.currentPassword)
    formData.append('newPassword', data.newPassword)

    const result = await changePassword(formData)

    if (result?.error) {
      toast.error(result.error)
      setIsLoading(false)
    }
    // On success, changePassword signs out and redirects to /login?message=password-changed
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
        <FormField
          control={form.control}
          name="currentPassword"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Current Password</FormLabel>
              <FormControl>
                <Input
                  type="password"
                  autoComplete="current-password"
                  disabled={isLoading}
                  {...field}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="newPassword"
          render={({ field }) => (
            <FormItem>
              <FormLabel>New Password</FormLabel>
              <FormControl>
                <Input
                  type="password"
                  autoComplete="new-password"
                  disabled={isLoading}
                  {...field}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="confirmNewPassword"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Confirm New Password</FormLabel>
              <FormControl>
                <Input
                  type="password"
                  autoComplete="new-password"
                  disabled={isLoading}
                  {...field}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <div className="rounded-md bg-muted p-3 text-sm text-muted-foreground">
          Password must be at least 8 characters with uppercase, lowercase, and a number.
          Changing your password will sign you out of all devices.
        </div>
        <Button type="submit" disabled={isLoading}>
          {isLoading ? 'Changing...' : 'Change Password'}
        </Button>
      </form>
    </Form>
  )
}
```

Create account settings page at app/(protected)/account/settings/page.tsx:

```typescript
import { redirect } from 'next/navigation'
import Link from 'next/link'
import Image from 'next/image'
import { createClient } from '@/lib/supabase/server'
import { ChangePasswordForm } from '@/components/auth/change-password-form'
import { UserMenu } from '@/components/navigation/user-menu'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

export default async function AccountSettingsPage() {
  const supabase = await createClient()

  // IMPORTANT: Always use getUser(), not getSession() on server
  const { data: { user }, error } = await supabase.auth.getUser()

  if (error || !user) {
    redirect('/login')
  }

  return (
    <div className="min-h-screen">
      {/* Header */}
      <header className="border-b">
        <div className="container mx-auto flex h-16 items-center justify-between px-4">
          <Link href="/dashboard">
            <Image src="/logo.svg" alt="AnimateLabs" width={120} height={32} priority />
          </Link>
          <UserMenu user={user} />
        </div>
      </header>

      {/* Main Content */}
      <main className="container mx-auto max-w-2xl px-4 py-8">
        <h1 className="mb-8 text-3xl font-bold">Account Settings</h1>

        {/* Email Section */}
        <Card className="mb-6">
          <CardHeader>
            <CardTitle>Email Address</CardTitle>
            <CardDescription>Your email is used for login and notifications</CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm font-medium">{user.email}</p>
            <p className="mt-1 text-xs text-muted-foreground">
              Contact support if you need to change your email address.
            </p>
          </CardContent>
        </Card>

        {/* Password Section */}
        <Card>
          <CardHeader>
            <CardTitle>Change Password</CardTitle>
            <CardDescription>Update your password to keep your account secure</CardDescription>
          </CardHeader>
          <CardContent>
            <ChangePasswordForm />
          </CardContent>
        </Card>
      </main>
    </div>
  )
}
```

Key implementation notes:
- Uses getUser() (not getSession()) for secure server-side auth check
- Redirects to /login if not authenticated
- Email displayed as read-only per CONTEXT.md decision
- Password change form verifies current password first
- Header includes UserMenu component for consistency
  </action>
  <verify>
- `npx tsc --noEmit` passes
- components/auth/change-password-form.tsx exports ChangePasswordForm
- app/(protected)/account/settings/page.tsx renders settings page
  </verify>
  <done>Account settings page shows email (read-only), password change form verifies current password and forces global logout</done>
</task>

<task type="auto">
  <name>Task 2: Create user menu component and dashboard placeholder</name>
  <files>components/navigation/user-menu.tsx, app/(protected)/dashboard/page.tsx</files>
  <action>
Create user menu at components/navigation/user-menu.tsx:

```typescript
'use client'

import { User } from '@supabase/supabase-js'
import Link from 'next/link'
import { Settings, LogOut } from 'lucide-react'
import { signOut } from '@/lib/actions/auth'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'

interface UserMenuProps {
  user: User
}

export function UserMenu({ user }: UserMenuProps) {
  const initials = user.email?.slice(0, 2).toUpperCase() ?? 'U'

  return (
    <DropdownMenu>
      <DropdownMenuTrigger className="focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 rounded-full">
        <Avatar>
          <AvatarImage src={user.user_metadata?.avatar_url} alt={user.email || 'User'} />
          <AvatarFallback>{initials}</AvatarFallback>
        </Avatar>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-56">
        <div className="px-2 py-1.5">
          <p className="text-sm font-medium truncate">{user.email}</p>
        </div>
        <DropdownMenuSeparator />
        <DropdownMenuItem asChild>
          <Link href="/account/settings" className="flex cursor-pointer items-center">
            <Settings className="mr-2 h-4 w-4" />
            Settings
          </Link>
        </DropdownMenuItem>
        <DropdownMenuSeparator />
        <DropdownMenuItem
          onClick={() => signOut()}
          className="cursor-pointer text-destructive focus:text-destructive"
        >
          <LogOut className="mr-2 h-4 w-4" />
          Sign out
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

Create dashboard placeholder at app/(protected)/dashboard/page.tsx:

```typescript
import { redirect } from 'next/navigation'
import Link from 'next/link'
import Image from 'next/image'
import { createClient } from '@/lib/supabase/server'
import { UserMenu } from '@/components/navigation/user-menu'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'

export default async function DashboardPage() {
  const supabase = await createClient()

  // IMPORTANT: Always use getUser(), not getSession() on server
  const { data: { user }, error } = await supabase.auth.getUser()

  if (error || !user) {
    redirect('/login')
  }

  return (
    <div className="min-h-screen">
      {/* Header */}
      <header className="border-b">
        <div className="container mx-auto flex h-16 items-center justify-between px-4">
          <Link href="/dashboard">
            <Image src="/logo.svg" alt="AnimateLabs" width={120} height={32} priority />
          </Link>
          <UserMenu user={user} />
        </div>
      </header>

      {/* Main Content */}
      <main className="container mx-auto px-4 py-8">
        <div className="mb-8 flex items-center justify-between">
          <h1 className="text-3xl font-bold">Dashboard</h1>
          <Button disabled>Create Video</Button>
        </div>

        {/* Placeholder content */}
        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          <Card>
            <CardHeader>
              <CardTitle>Credits</CardTitle>
              <CardDescription>Your available credits</CardDescription>
            </CardHeader>
            <CardContent>
              <p className="text-3xl font-bold">0</p>
              <p className="text-sm text-muted-foreground">Subscribe to get credits</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>Recent Videos</CardTitle>
              <CardDescription>Your latest creations</CardDescription>
            </CardHeader>
            <CardContent>
              <p className="text-sm text-muted-foreground">No videos yet</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>Welcome, {user.email?.split('@')[0]}!</CardTitle>
              <CardDescription>Get started with AnimateLabs</CardDescription>
            </CardHeader>
            <CardContent>
              <p className="text-sm text-muted-foreground">
                Subscribe to a plan to start creating professional logo animations.
              </p>
            </CardContent>
          </Card>
        </div>
      </main>
    </div>
  )
}
```

Key implementation notes:
- UserMenu is a client component (handles onClick for signOut)
- Receives full User object from server component
- Shows email in dropdown header
- Settings link goes to /account/settings
- Sign out calls signOut server action which redirects to /login
- Dashboard is a placeholder - will be expanded in Phase 5
- Both pages share same header layout with UserMenu
  </action>
  <verify>
- `npx tsc --noEmit` passes
- components/navigation/user-menu.tsx exports UserMenu
- app/(protected)/dashboard/page.tsx renders dashboard with UserMenu
  </verify>
  <done>User menu shows avatar, email, settings link, logout. Dashboard placeholder shows welcome content with header.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Visit /dashboard without auth - redirects to /login
3. Visit /account/settings without auth - redirects to /login
4. (With test account) Visit /dashboard - shows welcome content with user menu
5. (With test account) Click user menu - dropdown shows email, settings, logout
6. (With test account) Click settings - goes to /account/settings
7. (With test account) Click logout - redirects to /login
</verification>

<success_criteria>
- components/auth/change-password-form.tsx exists with current password verification
- components/navigation/user-menu.tsx exists with dropdown showing settings and logout
- app/(protected)/account/settings/page.tsx shows email (read-only) and password change form
- app/(protected)/dashboard/page.tsx shows placeholder with user menu
- Protected pages redirect to /login when unauthenticated
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-account/02-05-SUMMARY.md`
</output>
