---
phase: 04-core-video-creation
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - supabase/migrations/00003_storage_setup.sql
  - .env.example
autonomous: true
user_setup:
  - service: supabase
    why: "Storage bucket creation and migration execution"
    env_vars: []
    dashboard_config:
      - task: "Create 'logos' storage bucket (public)"
        location: "Supabase Dashboard -> Storage -> New bucket"
      - task: "Run migration 00003_storage_setup.sql"
        location: "Supabase Dashboard -> SQL Editor OR supabase db push"

must_haves:
  truths:
    - "Storage bucket 'logos' exists for logo uploads"
    - "RLS policies allow users to upload/read their own files"
    - "Videos table has webhook_id column for idempotent callbacks"
  artifacts:
    - path: "supabase/migrations/00003_storage_setup.sql"
      provides: "Storage RLS policies and videos table webhook_id column"
      contains: "storage.objects"
    - path: ".env.example"
      provides: "Documentation for n8n webhook environment variables"
      contains: "N8N_WEBHOOK_URL"
  key_links:
    - from: "storage.objects RLS policy"
      to: "user_id folder path"
      via: "storage.foldername(name)[1]"
      pattern: "foldername.*auth\\.uid"
---

<objective>
Create Supabase Storage bucket and RLS policies for logo uploads, add webhook_id column to videos table.

Purpose: Enable secure, user-scoped file uploads and idempotent webhook processing.
Output: Migration file for storage policies and videos table update, updated .env.example.
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-video-creation/04-RESEARCH.md
@supabase/migrations/00001_initial_schema.sql (existing schema)
@supabase/migrations/00002_webhook_events.sql (migration pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage migration with RLS policies</name>
  <files>supabase/migrations/00003_storage_setup.sql</files>
  <action>
Create supabase/migrations/00003_storage_setup.sql:

```sql
-- Storage Setup for Logo Uploads
-- Phase 4: Core Video Creation
--
-- This migration:
-- 1. Creates RLS policies for the 'logos' storage bucket
-- 2. Adds webhook_id column to videos table for idempotent callbacks
--
-- NOTE: The 'logos' bucket must be created manually in Supabase Dashboard
-- Go to Storage -> New bucket -> Name: "logos", Public: checked

-- ============================================
-- STORAGE RLS POLICIES
-- ============================================
-- Bucket 'logos' stores user-uploaded logo files
-- Path format: {user_id}/{file_uuid}.{extension}
-- Users can only access files in their own folder

-- Allow authenticated users to upload to their own folder
CREATE POLICY "Users can upload logos to own folder"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'logos' AND
  (storage.foldername(name))[1] = auth.uid()::text
);

-- Allow users to read their own logos
CREATE POLICY "Users can read own logos"
ON storage.objects
FOR SELECT
TO authenticated
USING (
  bucket_id = 'logos' AND
  (storage.foldername(name))[1] = auth.uid()::text
);

-- Allow users to delete their own logos
CREATE POLICY "Users can delete own logos"
ON storage.objects
FOR DELETE
TO authenticated
USING (
  bucket_id = 'logos' AND
  (storage.foldername(name))[1] = auth.uid()::text
);

-- Allow public read access to logos bucket (for n8n to fetch)
-- This is safe because:
-- 1. File paths use UUIDs (not guessable)
-- 2. Files are only accessible if you know the exact path
-- 3. n8n needs to download logos without auth
CREATE POLICY "Public read access to logos"
ON storage.objects
FOR SELECT
TO public
USING (bucket_id = 'logos');

-- ============================================
-- VIDEOS TABLE UPDATE
-- ============================================
-- Add webhook_id column for idempotent callback processing
-- n8n sends x-webhook-id header to prevent duplicate status updates

-- Note: We use n8n_execution_id (already exists) for idempotency
-- No new column needed - n8n_execution_id serves this purpose

-- Add index for faster lookups by status (used in dashboard queries)
CREATE INDEX IF NOT EXISTS videos_user_status_idx
ON public.videos(user_id, status);

-- ============================================
-- COMMENTS
-- ============================================
COMMENT ON POLICY "Users can upload logos to own folder" ON storage.objects IS
'Authenticated users can upload files to logos/{their_user_id}/ folder';

COMMENT ON POLICY "Users can read own logos" ON storage.objects IS
'Authenticated users can read files from their own folder in logos bucket';

COMMENT ON POLICY "Users can delete own logos" ON storage.objects IS
'Authenticated users can delete files from their own folder in logos bucket';

COMMENT ON POLICY "Public read access to logos" ON storage.objects IS
'Public read access allows n8n workflow to download logos for video generation';
```

IMPORTANT notes:
- The 'logos' bucket must be created MANUALLY in Supabase Dashboard (migrations cannot create buckets)
- Bucket should be PUBLIC for n8n to access logos
- RLS policies restrict uploads to user's own folder
- Path format `{user_id}/{uuid}.ext` enforced by policy
- n8n_execution_id already exists in videos table (from 00001_initial_schema.sql)
  </action>
  <verify>
  - File exists at supabase/migrations/00003_storage_setup.sql
  - File contains policies for storage.objects with bucket_id = 'logos'
  - File contains index creation for videos_user_status_idx
  - SQL syntax is valid (no obvious errors)
  </verify>
  <done>Storage migration created with RLS policies for user-scoped logo uploads and public read access for n8n.</done>
</task>

<task type="auto">
  <name>Task 2: Update .env.example with n8n webhook variables</name>
  <files>.env.example</files>
  <action>
Read the current .env.example and add n8n webhook environment variables.

Add the following variables to .env.example (if not already present):

```env
# n8n Webhook Integration
# Video creation workflow trigger and callback
N8N_WEBHOOK_URL=https://your-n8n-instance.com/webhook/video-create
N8N_WEBHOOK_SECRET=your-webhook-secret-here
```

Also ensure these Supabase variables are documented:
- SUPABASE_SERVICE_ROLE_KEY (needed for webhook callback endpoint)

The complete .env.example should have sections for:
1. Supabase (public + service role)
2. Stripe (publishable + secret + webhook + price IDs)
3. n8n (webhook URL + secret)
  </action>
  <verify>
  - .env.example contains N8N_WEBHOOK_URL
  - .env.example contains N8N_WEBHOOK_SECRET
  - .env.example contains SUPABASE_SERVICE_ROLE_KEY
  </verify>
  <done>Environment variables documented for n8n webhook integration.</done>
</task>

</tasks>

<verification>
1. Check supabase/migrations/00003_storage_setup.sql exists with:
   - INSERT, SELECT, DELETE policies for storage.objects
   - Public read policy for logos bucket
   - Index on videos(user_id, status)
2. Check .env.example contains:
   - N8N_WEBHOOK_URL
   - N8N_WEBHOOK_SECRET
   - SUPABASE_SERVICE_ROLE_KEY
</verification>

<success_criteria>
- Migration file creates RLS policies for storage.objects (logos bucket)
- Policies enforce user-scoped access: users can only upload/read/delete files in {user_id}/ folder
- Public read access enabled for n8n to fetch logos
- Index created for videos(user_id, status) for efficient dashboard queries
- .env.example documents N8N_WEBHOOK_URL, N8N_WEBHOOK_SECRET, and SUPABASE_SERVICE_ROLE_KEY
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-video-creation/04-03-SUMMARY.md`

**User Setup Required After This Plan:**
1. Create 'logos' storage bucket in Supabase Dashboard (public bucket)
2. Run migration 00003_storage_setup.sql via SQL Editor or `supabase db push`
3. Add N8N_WEBHOOK_URL and N8N_WEBHOOK_SECRET to .env.local
</output>
