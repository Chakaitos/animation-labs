---
phase: 04-core-video-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - next.config.ts
  - lib/validations/video-schema.ts
  - lib/utils/color-extraction.ts
  - lib/utils/file-validation.ts
autonomous: true

must_haves:
  truths:
    - "Video creation dependencies are installed and importable"
    - "Next.js accepts file uploads up to 25MB via Server Actions"
    - "Zod schema validates all video parameters with correct types and constraints"
    - "Color extraction utility works in browser context"
    - "File validation utility detects magic bytes for security"
  artifacts:
    - path: "lib/validations/video-schema.ts"
      provides: "Video creation Zod schema with TypeScript types"
      exports: ["videoSchema", "VideoFormValues"]
    - path: "lib/utils/color-extraction.ts"
      provides: "node-vibrant wrapper for logo color extraction"
      exports: ["extractColors"]
    - path: "lib/utils/file-validation.ts"
      provides: "Magic byte validation for file security"
      exports: ["validateImageFile", "ALLOWED_IMAGE_TYPES"]
    - path: "next.config.ts"
      provides: "Server Actions body size configuration"
      contains: "bodySizeLimit"
  key_links:
    - from: "lib/validations/video-schema.ts"
      to: "zod"
      via: "import z from 'zod'"
      pattern: "z\\.object"
    - from: "lib/utils/color-extraction.ts"
      to: "node-vibrant"
      via: "import Vibrant"
      pattern: "Vibrant"
---

<objective>
Install video creation dependencies and create foundational utilities for the multi-step form.

Purpose: Establish the foundation for file uploads, color extraction, and form validation before building UI or server actions.
Output: Dependencies installed, next.config.ts configured, validation schemas and utility functions ready.
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-video-creation/04-RESEARCH.md
@lib/validations/auth.ts (pattern for Zod schemas)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure next.config.ts</name>
  <files>package.json, next.config.ts</files>
  <action>
1. Install video creation dependencies:
   ```bash
   npm install react-dropzone node-vibrant file-type
   ```

2. Update next.config.ts to allow larger file uploads for Server Actions:
   ```typescript
   import type { NextConfig } from "next";

   const nextConfig: NextConfig = {
     experimental: {
       serverActions: {
         bodySizeLimit: '25mb', // Match Supabase Storage limit for logo uploads
       },
     },
   };

   export default nextConfig;
   ```

IMPORTANT: The bodySizeLimit is required because Next.js defaults to 1MB, which will fail for larger logo files. 25MB matches Supabase Storage's default limit.
  </action>
  <verify>
  - `npm ls react-dropzone node-vibrant file-type` shows all three installed
  - `grep -r "bodySizeLimit" next.config.ts` finds the config
  - `npm run build` succeeds (no config errors)
  </verify>
  <done>Dependencies installed and next.config.ts configured with 25MB body size limit for Server Actions.</done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schema for video creation</name>
  <files>lib/validations/video-schema.ts</files>
  <action>
Create lib/validations/video-schema.ts following the pattern from lib/validations/auth.ts:

```typescript
import { z } from 'zod'

// Video duration options (in seconds) - matches UI dropdown
export const VIDEO_DURATIONS = ['4s', '6s', '8s', '15s'] as const
export type VideoDuration = typeof VIDEO_DURATIONS[number]

// Video quality options - matches UI dropdown
export const VIDEO_QUALITIES = ['standard', 'premium', '1080p', '4k'] as const
export type VideoQuality = typeof VIDEO_QUALITIES[number]

// Style presets for video generation
export const STYLE_PRESETS = [
  'modern',
  'minimal',
  'bold',
  'elegant',
  'playful',
  'corporate',
  'cinematic',
  'custom',
] as const
export type StylePreset = typeof STYLE_PRESETS[number]

// Hex color validation pattern
const hexColorRegex = /^#[0-9A-Fa-f]{6}$/

// Schema for the video creation form
export const videoSchema = z.object({
  brandName: z
    .string()
    .min(1, 'Brand name is required')
    .max(100, 'Brand name must be 100 characters or less'),
  duration: z.enum(VIDEO_DURATIONS, {
    errorMap: () => ({ message: 'Please select a duration' }),
  }),
  quality: z.enum(VIDEO_QUALITIES, {
    errorMap: () => ({ message: 'Please select a quality' }),
  }),
  style: z.enum(STYLE_PRESETS, {
    errorMap: () => ({ message: 'Please select a style' }),
  }),
  creativeDirection: z
    .string()
    .max(500, 'Creative direction must be 500 characters or less')
    .optional()
    .or(z.literal('')),
  primaryColor: z
    .string()
    .regex(hexColorRegex, 'Invalid hex color format'),
  secondaryColor: z
    .string()
    .regex(hexColorRegex, 'Invalid hex color format'),
})

// Type export for form usage
export type VideoFormValues = z.infer<typeof videoSchema>

// Default values for the form (opinionated defaults from CONTEXT.md)
export const videoFormDefaults: VideoFormValues = {
  brandName: '',
  duration: '15s',
  quality: '1080p',
  style: 'modern',
  creativeDirection: '',
  primaryColor: '#000000',
  secondaryColor: '#666666',
}
```

Note: The schema matches the research patterns and handles:
- Required brand name with length limits
- Enum validation for duration/quality/style dropdowns
- Optional creative direction with max length
- Hex color validation for extracted colors
- Type exports for React Hook Form integration
  </action>
  <verify>
  - `npx tsc --noEmit` passes (TypeScript compiles)
  - File exports videoSchema, VideoFormValues, videoFormDefaults
  - File exports VIDEO_DURATIONS, VIDEO_QUALITIES, STYLE_PRESETS constants
  </verify>
  <done>Video validation schema created with all form fields, type exports, and default values.</done>
</task>

<task type="auto">
  <name>Task 3: Create color extraction and file validation utilities</name>
  <files>lib/utils/color-extraction.ts, lib/utils/file-validation.ts</files>
  <action>
1. Create lib/utils/color-extraction.ts for client-side color extraction:

```typescript
import Vibrant from 'node-vibrant'

export interface ExtractedColors {
  primary: string
  secondary: string
}

/**
 * Extract primary and secondary colors from an image file.
 * Uses node-vibrant for semantic color extraction (Vibrant, Muted swatches).
 *
 * @param file - Image file (JPG, PNG, or WebP)
 * @returns Object with primary (Vibrant) and secondary (Muted) hex colors
 */
export async function extractColors(file: File): Promise<ExtractedColors> {
  // Create an image bitmap from the file
  const img = await createImageBitmap(file)

  // Draw to canvas for Vibrant analysis
  const canvas = document.createElement('canvas')
  canvas.width = img.width
  canvas.height = img.height
  const ctx = canvas.getContext('2d')

  if (!ctx) {
    throw new Error('Failed to get canvas context')
  }

  ctx.drawImage(img, 0, 0)

  // Extract colors using Vibrant
  const vibrant = new Vibrant(canvas)
  const palette = await vibrant.getPalette()

  // Use Vibrant as primary, falling back to DarkVibrant
  // Use Muted as secondary, falling back to LightMuted
  const primary = palette.Vibrant?.hex || palette.DarkVibrant?.hex || '#000000'
  const secondary = palette.Muted?.hex || palette.LightMuted?.hex || '#666666'

  return { primary, secondary }
}
```

2. Create lib/utils/file-validation.ts for server-side magic byte validation:

```typescript
import { fileTypeFromBuffer } from 'file-type'

// Allowed MIME types for logo uploads (Veo 3 requirement - no SVG)
export const ALLOWED_IMAGE_TYPES = [
  'image/jpeg',
  'image/png',
  'image/webp',
] as const

export type AllowedImageType = typeof ALLOWED_IMAGE_TYPES[number]

// Maximum file size: 25MB (Supabase Storage limit)
export const MAX_FILE_SIZE = 25 * 1024 * 1024

export interface FileValidationResult {
  valid: boolean
  error?: string
  mimeType?: string
}

/**
 * Validate an image file using magic bytes (server-side security).
 * Never trust client-side MIME type - always verify magic bytes.
 *
 * @param file - File object from FormData
 * @returns Validation result with error message if invalid
 */
export async function validateImageFile(file: File): Promise<FileValidationResult> {
  // Check file size
  if (file.size > MAX_FILE_SIZE) {
    return {
      valid: false,
      error: `File size exceeds ${MAX_FILE_SIZE / 1024 / 1024}MB limit`,
    }
  }

  // Read file buffer for magic byte detection
  const buffer = Buffer.from(await file.arrayBuffer())

  // Detect actual file type from magic bytes
  const type = await fileTypeFromBuffer(buffer)

  // Verify it's an allowed image type
  if (!type || !ALLOWED_IMAGE_TYPES.includes(type.mime as AllowedImageType)) {
    return {
      valid: false,
      error: 'Invalid file type. Please upload a JPG, PNG, or WebP image.',
    }
  }

  return {
    valid: true,
    mimeType: type.mime,
  }
}
```

IMPORTANT:
- color-extraction.ts is CLIENT-ONLY (uses canvas/createImageBitmap)
- file-validation.ts is SERVER-ONLY (uses Buffer, file-type)
- Never mix these - client components import color-extraction, Server Actions import file-validation
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - lib/utils/color-extraction.ts exports extractColors and ExtractedColors
  - lib/utils/file-validation.ts exports validateImageFile, ALLOWED_IMAGE_TYPES, MAX_FILE_SIZE
  - Both files have proper JSDoc comments
  </verify>
  <done>Color extraction utility (client-side) and file validation utility (server-side magic bytes) created.</done>
</task>

</tasks>

<verification>
1. Run `npm ls react-dropzone node-vibrant file-type` - all three installed
2. Run `npx tsc --noEmit` - TypeScript compiles without errors
3. Run `npm run build` - build succeeds with new config
4. Check file exports:
   - lib/validations/video-schema.ts exports videoSchema, VideoFormValues, videoFormDefaults
   - lib/utils/color-extraction.ts exports extractColors
   - lib/utils/file-validation.ts exports validateImageFile, ALLOWED_IMAGE_TYPES
</verification>

<success_criteria>
- All three npm packages installed successfully
- next.config.ts has serverActions.bodySizeLimit: '25mb'
- Video schema validates: brandName (required, max 100), duration (enum), quality (enum), style (enum), creativeDirection (optional, max 500), primaryColor (hex), secondaryColor (hex)
- Color extraction function returns { primary, secondary } hex colors
- File validation function checks magic bytes and returns { valid, error?, mimeType? }
- TypeScript compiles and build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-video-creation/04-01-SUMMARY.md`
</output>
