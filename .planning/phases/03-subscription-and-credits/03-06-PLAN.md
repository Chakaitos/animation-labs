---
phase: 03-subscription-and-credits
plan: 06
type: execute
wave: 4
depends_on: ["03-04", "03-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Stripe products and prices exist in Stripe Dashboard"
    - "Environment variables are configured"
    - "Database migration has been applied"
    - "Webhook endpoint is registered in Stripe"
    - "Full subscription flow works end-to-end"
---

<objective>
Human verification of complete subscription and credits flow

Purpose: Validate the entire billing system works end-to-end with real Stripe integration
Output: Verified working subscription flow

Business Rules:
- Credit packs (Small/Medium/Large) require an active subscription to purchase
- Single credit ($5) can be purchased anytime without a subscription
- Subscription prices: Starter $30/month (10 credits), Professional $75/month (30 credits)
- Credit pack prices: Small $20 (5 credits), Medium $35 (10 credits), Large $65 (20 credits)
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-subscription-and-credits/03-RESEARCH.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Stripe Dashboard Setup</name>
  <action>
Human must complete Stripe Dashboard configuration:

1. **Create Products in Stripe Dashboard** (https://dashboard.stripe.com/test/products)

   Create the following products with recurring prices:

   **Starter Plan:**
   - Name: "Starter"
   - Price: $30/month (recurring)
   - Credits: 10/month
   - Copy the Price ID (price_xxx)

   **Professional Plan:**
   - Name: "Professional"
   - Price: $75/month (recurring)
   - Credits: 30/month
   - Copy the Price ID (price_xxx)

   **Single Credit (No Subscription Required):**
   - Name: "1 Credit"
   - Price: $5 (one-time)
   - Copy the Price ID (price_xxx)

   **Credit Pack - Small (Requires Active Subscription):**
   - Name: "5 Credits"
   - Price: $20 (one-time)
   - Copy the Price ID (price_xxx)

   **Credit Pack - Medium (Requires Active Subscription):**
   - Name: "10 Credits"
   - Price: $35 (one-time)
   - Copy the Price ID (price_xxx)

   **Credit Pack - Large (Requires Active Subscription):**
   - Name: "20 Credits"
   - Price: $65 (one-time)
   - Copy the Price ID (price_xxx)

2. **Get API Keys** (https://dashboard.stripe.com/test/apikeys)
   - Copy Secret key (sk_test_xxx)

3. **Configure Customer Portal** (https://dashboard.stripe.com/test/settings/billing/portal)
   - Enable: Allow customers to cancel subscriptions
   - Enable: Allow customers to update payment methods
   - Enable: Allow customers to view invoice history
   - Add both products for plan switching

4. **Create Webhook Endpoint** (https://dashboard.stripe.com/test/webhooks)
   - For local testing: Use Stripe CLI `stripe listen --forward-to localhost:3000/api/webhooks/stripe`
   - Or add endpoint URL: https://your-domain.com/api/webhooks/stripe
   - Select events:
     - checkout.session.completed
     - customer.subscription.updated
     - customer.subscription.deleted
     - invoice.payment_succeeded
     - invoice.payment_failed
   - Copy Webhook signing secret (whsec_xxx)

5. **Update .env.local** with all values:
   ```
   STRIPE_SECRET_KEY=sk_test_xxx
   STRIPE_WEBHOOK_SECRET=whsec_xxx
   STRIPE_PRICE_STARTER=price_xxx
   STRIPE_PRICE_PROFESSIONAL=price_xxx
   STRIPE_PRICE_SINGLE_CREDIT=price_xxx
   STRIPE_PRICE_CREDITS_SMALL=price_xxx
   STRIPE_PRICE_CREDITS_MEDIUM=price_xxx
   STRIPE_PRICE_CREDITS_LARGE=price_xxx
   ```

6. **Apply Database Migration**
   - Go to Supabase Dashboard -> SQL Editor
   - Run the contents of `supabase/migrations/00002_webhook_events.sql`
   - Verify: webhook_events table exists, subscriptions.overage_credits column exists
  </action>
  <resume-signal>Type "setup complete" when all Stripe products, API keys, webhook, and migration are configured</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Test Complete Subscription Flow</name>
  <what-built>
Complete subscription and credits system:
- Stripe SDK integration
- Webhook handler with idempotency
- Checkout Server Actions
- Subscribe page with plan cards
- Billing page with portal access and credit packs
- Dashboard with credit balance
  </what-built>
  <how-to-verify>
**Start dev server and Stripe CLI webhook forwarding:**
```bash
# Terminal 1
npm run dev

# Terminal 2 (if testing locally)
stripe listen --forward-to localhost:3000/api/webhooks/stripe
```

**Test Flow 1: New Subscription**
1. Go to http://localhost:3000/dashboard (logged in)
2. Should see "Get Started" card since no subscription
3. Click "View Plans" -> goes to /subscribe
4. Verify both Starter ($30 - 10 credits) and Professional ($75 - 30 credits) plans show
5. Click "Subscribe" on Professional plan
6. Stripe Checkout should open
7. Use test card: 4242 4242 4242 4242, any future date, any CVC
8. Complete checkout
9. Should redirect to /dashboard?checkout=success
10. Verify credit balance shows "30" (Professional plan credits)
11. Check Stripe CLI output - should see webhook received and processed

**Test Flow 2: Billing Page**
1. Go to /billing
2. Verify current plan shows "Professional" with status "active"
3. Verify renewal date shows (~1 month from now)
4. Click "Manage Subscription" -> Stripe Customer Portal should open
5. Can navigate portal (don't cancel yet)
6. Return to /billing

**Test Flow 3: Credit Pack Purchase (Requires Active Subscription)**
1. On /billing with active subscription, find "Buy More Credits" section
2. Should see three credit packs: Small (5 for $20), Medium (10 for $35), Large (20 for $65)
3. Click "Purchase" on "Small" pack
4. Complete Stripe Checkout
5. Verify credit balance increased by 5
6. Check credit history shows "Purchased 5 Credits credit pack"

**Test Flow 4: Single Credit Purchase (No Subscription Required)**
1. Log out and create a new test user (or cancel existing subscription)
2. Go to /billing without an active subscription
3. Should see "Buy 1 Credit" option for $5 (always available)
4. Credit packs should be hidden or disabled
5. Purchase single credit
6. Complete Stripe Checkout
7. Verify credit balance shows 1
8. Check credit history shows "Purchased 1 credit"

**Test Flow 5: Credit History**
1. On /billing, scroll to Credit History
2. Should show at least:
   - "Professional plan subscription started" (+30)
   - "Purchased 5 Credits credit pack" (+5)

**Expected Results:**
- All pages render without errors
- Stripe Checkout flows complete successfully
- Webhooks process without errors (check CLI output)
- Credit balances update correctly
- Customer Portal opens and returns correctly
  </how-to-verify>
  <resume-signal>Type "verified" if all flows work, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- Human confirms Stripe Dashboard setup complete
- Human confirms all checkout flows work
- Human confirms webhooks process correctly
- Human confirms credit balances update
</verification>

<success_criteria>
1. Stripe products and prices created in Dashboard
2. Environment variables configured
3. Database migration applied (webhook_events table, overage_credits column)
4. Webhook endpoint receiving events
5. New user can subscribe successfully
6. Credits granted after checkout
7. Billing page shows correct subscription info
8. Customer Portal accessible
9. Credit pack purchase works
10. Credit history displays transactions
</success_criteria>

<output>
After completion, create `.planning/phases/03-subscription-and-credits/03-06-SUMMARY.md`
</output>
