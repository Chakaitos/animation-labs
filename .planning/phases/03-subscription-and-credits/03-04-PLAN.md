---
phase: 03-subscription-and-credits
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - app/(protected)/subscribe/page.tsx
  - components/SubscribePlanCard.tsx
  - components/CreditBalance.tsx
  - app/(protected)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view available subscription plans"
    - "User can select and purchase a plan"
    - "Dashboard displays current credit balance"
    - "Free users see subscribe CTA instead of credit balance"
  artifacts:
    - path: "app/(protected)/subscribe/page.tsx"
      provides: "Plan selection page"
      min_lines: 50
    - path: "components/SubscribePlanCard.tsx"
      provides: "Reusable plan card component"
      min_lines: 30
    - path: "components/CreditBalance.tsx"
      provides: "Credit balance display component"
      min_lines: 20
  key_links:
    - from: "app/(protected)/subscribe/page.tsx"
      to: "createSubscriptionCheckout"
      via: "form action"
      pattern: "action.*createSubscriptionCheckout"
    - from: "components/CreditBalance.tsx"
      to: "getCreditBalance"
      via: "Server Action call"
      pattern: "getCreditBalance"
---

<objective>
Create subscription page and dashboard credit display

Purpose: Enable users to subscribe to plans and view their credit balance
Output: Subscribe page with plan cards and dashboard with credit balance
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-subscription-and-credits/03-RESEARCH.md
@app/(protected)/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plan card component and subscribe page</name>
  <files>components/SubscribePlanCard.tsx, app/(protected)/subscribe/page.tsx</files>
  <action>
Create `components/SubscribePlanCard.tsx`:
```typescript
'use client'

import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card'
import { Check } from 'lucide-react'
import { useTransition } from 'react'
import { toast } from 'sonner'
import { createSubscriptionCheckout } from '@/lib/actions/checkout'
import type { PlanId } from '@/lib/stripe/config'

interface SubscribePlanCardProps {
  planId: PlanId
  name: string
  description: string
  credits: number
  features: string[]
  price: string
  recommended?: boolean
  currentPlan?: boolean
}

export function SubscribePlanCard({
  planId,
  name,
  description,
  credits,
  features,
  price,
  recommended = false,
  currentPlan = false,
}: SubscribePlanCardProps) {
  const [isPending, startTransition] = useTransition()

  const handleSubscribe = () => {
    startTransition(async () => {
      const result = await createSubscriptionCheckout(planId)
      if (result?.error) {
        toast.error(result.error)
      }
      // Redirect happens in the action
    })
  }

  return (
    <Card className={`relative flex flex-col ${recommended ? 'border-primary shadow-lg' : ''}`}>
      {recommended && (
        <div className="absolute -top-3 left-1/2 -translate-x-1/2">
          <span className="bg-primary text-primary-foreground text-xs font-semibold px-3 py-1 rounded-full">
            Recommended
          </span>
        </div>
      )}
      <CardHeader>
        <CardTitle className="text-xl">{name}</CardTitle>
        <CardDescription>{description}</CardDescription>
        <div className="mt-4">
          <span className="text-3xl font-bold">{price}</span>
          <span className="text-muted-foreground">/month</span>
        </div>
      </CardHeader>
      <CardContent className="flex-grow">
        <ul className="space-y-2">
          {features.map((feature, index) => (
            <li key={index} className="flex items-center gap-2">
              <Check className="h-4 w-4 text-primary" />
              <span className="text-sm">{feature}</span>
            </li>
          ))}
        </ul>
      </CardContent>
      <CardFooter>
        {currentPlan ? (
          <Button className="w-full" variant="outline" disabled>
            Current Plan
          </Button>
        ) : (
          <Button
            className="w-full"
            variant={recommended ? 'default' : 'outline'}
            onClick={handleSubscribe}
            disabled={isPending}
          >
            {isPending ? 'Redirecting...' : 'Subscribe'}
          </Button>
        )}
      </CardFooter>
    </Card>
  )
}
```

Create `app/(protected)/subscribe/page.tsx`:
```typescript
import { createClient } from '@/lib/supabase/server'
import { PLANS, type PlanId } from '@/lib/stripe/config'
import { SubscribePlanCard } from '@/components/SubscribePlanCard'
import { redirect } from 'next/navigation'
import Link from 'next/link'
import Image from 'next/image'
import { Button } from '@/components/ui/button'
import { ArrowLeft } from 'lucide-react'

// Plan pricing (displayed only - actual prices come from Stripe)
const PLAN_PRICES: Record<PlanId, string> = {
  starter: '$19',
  professional: '$49',
}

export default async function SubscribePage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login?next=/subscribe')
  }

  // Check if user already has an active subscription
  const { data: subscription } = await supabase
    .from('subscriptions')
    .select('plan, status')
    .eq('user_id', user.id)
    .eq('status', 'active')
    .single()

  const currentPlan = subscription?.plan as PlanId | undefined

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <header className="border-b">
        <div className="container mx-auto px-4 py-4 flex items-center justify-between">
          <Link href="/dashboard" className="flex items-center gap-2">
            <Image src="/logo.svg" alt="AnimateLabs" width={120} height={32} />
          </Link>
          <Button variant="ghost" size="sm" asChild>
            <Link href="/dashboard">
              <ArrowLeft className="h-4 w-4 mr-2" />
              Back to Dashboard
            </Link>
          </Button>
        </div>
      </header>

      {/* Main Content */}
      <main className="container mx-auto px-4 py-12">
        <div className="text-center mb-12">
          <h1 className="text-3xl font-bold mb-4">
            {currentPlan ? 'Change Your Plan' : 'Choose Your Plan'}
          </h1>
          <p className="text-muted-foreground max-w-2xl mx-auto">
            Get professional logo animations at a fraction of freelancer costs.
            All plans include access to all animation styles and email support.
          </p>
        </div>

        <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
          {(Object.entries(PLANS) as [PlanId, typeof PLANS.starter][]).map(([planId, plan]) => (
            <SubscribePlanCard
              key={planId}
              planId={planId}
              name={plan.name}
              description={plan.description}
              credits={plan.credits}
              features={plan.features}
              price={PLAN_PRICES[planId]}
              recommended={planId === 'professional'}
              currentPlan={currentPlan === planId}
            />
          ))}
        </div>

        {currentPlan && (
          <div className="text-center mt-8">
            <p className="text-sm text-muted-foreground">
              Need to cancel or update payment method?{' '}
              <Link href="/billing" className="text-primary hover:underline">
                Go to Billing
              </Link>
            </p>
          </div>
        )}
      </main>
    </div>
  )
}
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Files exist at components/SubscribePlanCard.tsx and app/(protected)/subscribe/page.tsx
  </verify>
  <done>Subscribe page displays plan cards with pricing and features, handles current plan state</done>
</task>

<task type="auto">
  <name>Task 2: Create credit balance component and update dashboard</name>
  <files>components/CreditBalance.tsx, app/(protected)/dashboard/page.tsx</files>
  <action>
Create `components/CreditBalance.tsx`:
```typescript
import { getCreditBalance } from '@/lib/actions/billing'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Coins } from 'lucide-react'

interface CreditBalanceProps {
  className?: string
}

export async function CreditBalance({ className }: CreditBalanceProps) {
  const result = await getCreditBalance()

  if (result.error || !result.balance) {
    return (
      <Card className={className}>
        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
          <CardTitle className="text-sm font-medium">Credits</CardTitle>
          <Coins className="h-4 w-4 text-muted-foreground" />
        </CardHeader>
        <CardContent>
          <div className="text-2xl font-bold">--</div>
          <p className="text-xs text-muted-foreground">Unable to load balance</p>
        </CardContent>
      </Card>
    )
  }

  const { balance } = result

  return (
    <Card className={className}>
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium">Available Credits</CardTitle>
        <Coins className="h-4 w-4 text-muted-foreground" />
      </CardHeader>
      <CardContent>
        <div className="text-2xl font-bold">{balance.total}</div>
        {balance.total > 0 && (
          <p className="text-xs text-muted-foreground">
            {balance.subscription > 0 && `${balance.subscription} subscription`}
            {balance.subscription > 0 && balance.overage > 0 && ' + '}
            {balance.overage > 0 && `${balance.overage} bonus`}
          </p>
        )}
        {balance.total === 0 && (
          <p className="text-xs text-muted-foreground">
            No credits available
          </p>
        )}
      </CardContent>
    </Card>
  )
}
```

Update `app/(protected)/dashboard/page.tsx` to show credit balance:
```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import Link from 'next/link'
import Image from 'next/image'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { CreditBalance } from '@/components/CreditBalance'
import { UserMenu } from '@/components/UserMenu'
import { Plus, Video, CreditCard } from 'lucide-react'

export default async function DashboardPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  // Check if user has a subscription
  const { data: subscription } = await supabase
    .from('subscriptions')
    .select('plan, status, credits_remaining, overage_credits')
    .eq('user_id', user.id)
    .single()

  const hasSubscription = subscription && subscription.status === 'active'

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <header className="border-b">
        <div className="container mx-auto px-4 py-4 flex items-center justify-between">
          <Link href="/dashboard" className="flex items-center gap-2">
            <Image src="/logo.svg" alt="AnimateLabs" width={120} height={32} />
          </Link>
          <UserMenu user={user} />
        </div>
      </header>

      {/* Main Content */}
      <main className="container mx-auto px-4 py-8">
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-2xl font-bold">Dashboard</h1>
            <p className="text-muted-foreground">
              Welcome back{user.email ? `, ${user.email.split('@')[0]}` : ''}!
            </p>
          </div>
          {hasSubscription && (
            <Button asChild>
              <Link href="/create">
                <Plus className="h-4 w-4 mr-2" />
                Create Video
              </Link>
            </Button>
          )}
        </div>

        {/* Stats Grid */}
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3 mb-8">
          {hasSubscription ? (
            <>
              <CreditBalance />
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Videos Created</CardTitle>
                  <Video className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">0</div>
                  <p className="text-xs text-muted-foreground">This month</p>
                </CardContent>
              </Card>
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Current Plan</CardTitle>
                  <CreditCard className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold capitalize">{subscription?.plan}</div>
                  <p className="text-xs text-muted-foreground">
                    <Link href="/billing" className="hover:underline">
                      Manage billing
                    </Link>
                  </p>
                </CardContent>
              </Card>
            </>
          ) : (
            <Card className="md:col-span-2 lg:col-span-3">
              <CardHeader>
                <CardTitle>Get Started with AnimateLabs</CardTitle>
                <CardDescription>
                  Subscribe to a plan to start creating professional logo animations.
                </CardDescription>
              </CardHeader>
              <CardContent>
                <Button asChild>
                  <Link href="/subscribe">
                    View Plans
                  </Link>
                </Button>
              </CardContent>
            </Card>
          )}
        </div>

        {/* Recent Videos Section (placeholder) */}
        {hasSubscription && (
          <div>
            <h2 className="text-lg font-semibold mb-4">Recent Videos</h2>
            <Card>
              <CardContent className="py-8">
                <div className="text-center text-muted-foreground">
                  <Video className="h-12 w-12 mx-auto mb-4 opacity-50" />
                  <p>No videos yet</p>
                  <p className="text-sm">Create your first logo animation to get started.</p>
                  <Button className="mt-4" asChild>
                    <Link href="/create">
                      <Plus className="h-4 w-4 mr-2" />
                      Create Video
                    </Link>
                  </Button>
                </div>
              </CardContent>
            </Card>
          </div>
        )}
      </main>
    </div>
  )
}
```

Note: Assumes UserMenu component exists from Phase 2. If needed, we'll create it or import from existing location.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Files exist at components/CreditBalance.tsx and app/(protected)/dashboard/page.tsx
  </verify>
  <done>Dashboard shows credit balance for subscribers and subscribe CTA for free users</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- Subscribe page renders with plan cards
- Dashboard renders with credit balance or subscribe CTA
- TypeScript compilation passes
</verification>

<success_criteria>
1. Subscribe page shows both Starter and Professional plans
2. Plan cards display features, credits, and pricing
3. Current plan is indicated if user has subscription
4. Clicking Subscribe redirects to Stripe Checkout
5. Dashboard shows credit balance with breakdown (subscription + overage)
6. Dashboard shows subscribe CTA for users without subscription
7. Dashboard shows "Create Video" button for subscribers
</success_criteria>

<output>
After completion, create `.planning/phases/03-subscription-and-credits/03-04-SUMMARY.md`
</output>
