---
phase: 03-subscription-and-credits
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - lib/stripe/client.ts
  - lib/stripe/config.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Stripe SDK is installed and importable"
    - "Stripe client initializes with secret key"
    - "Plan configuration defines price IDs and credit amounts"
  artifacts:
    - path: "lib/stripe/client.ts"
      provides: "Stripe server client"
      exports: ["stripe"]
    - path: "lib/stripe/config.ts"
      provides: "Subscription plans configuration"
      exports: ["PLANS", "PRICE_IDS"]
  key_links:
    - from: "lib/stripe/client.ts"
      to: "process.env.STRIPE_SECRET_KEY"
      via: "Stripe constructor"
      pattern: "new Stripe.*STRIPE_SECRET_KEY"
---

<objective>
Install Stripe SDK and create configuration for subscription plans

Purpose: Foundation for all Stripe integration - checkout, webhooks, portal
Output: Stripe client utility and plan configuration with price IDs and credit amounts
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-subscription-and-credits/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe dependencies</name>
  <files>package.json</files>
  <action>
Install Stripe SDK packages:
```bash
npm install stripe @stripe/stripe-js
```

Stripe v17+ is the target version (ESM support, latest API). The @stripe/stripe-js package is for client-side Checkout redirect capability.
  </action>
  <verify>
Run `npm ls stripe @stripe/stripe-js` - both packages show installed with version numbers.
  </verify>
  <done>Both stripe (^17.x) and @stripe/stripe-js (^5.x) appear in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create Stripe client and plan configuration</name>
  <files>lib/stripe/client.ts, lib/stripe/config.ts, .env.example</files>
  <action>
Create `lib/stripe/client.ts`:
```typescript
import Stripe from 'stripe'

if (!process.env.STRIPE_SECRET_KEY) {
  throw new Error('STRIPE_SECRET_KEY is not set')
}

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
  apiVersion: '2025-01-27.acacia', // Use latest stable API version
  typescript: true,
})
```

Create `lib/stripe/config.ts`:
```typescript
// Subscription plan configuration
// Price IDs are environment-specific (test vs live mode)

export const PLANS = {
  starter: {
    name: 'Starter',
    description: '10 videos per month',
    credits: 10,
    priceId: process.env.STRIPE_PRICE_STARTER || '',
    features: [
      '10 videos per month',
      'Standard quality (1080p)',
      'All animation styles',
      'Email support',
    ],
  },
  professional: {
    name: 'Professional',
    description: '30 videos per month',
    credits: 30,
    priceId: process.env.STRIPE_PRICE_PROFESSIONAL || '',
    features: [
      '30 videos per month',
      'Premium quality (4K)',
      'All animation styles',
      'Priority email support',
      'Faster processing',
    ],
  },
} as const

export type PlanId = keyof typeof PLANS

// Credit pack configuration for overage purchases
export const CREDIT_PACKS = {
  small: {
    name: '5 Credits',
    credits: 5,
    priceId: process.env.STRIPE_PRICE_CREDITS_5 || '',
  },
  medium: {
    name: '10 Credits',
    credits: 10,
    priceId: process.env.STRIPE_PRICE_CREDITS_10 || '',
  },
  large: {
    name: '25 Credits',
    credits: 25,
    priceId: process.env.STRIPE_PRICE_CREDITS_25 || '',
  },
} as const

export type CreditPackId = keyof typeof CREDIT_PACKS

// Helper to get plan by price ID (for webhook processing)
export function getPlanByPriceId(priceId: string): PlanId | null {
  for (const [planId, plan] of Object.entries(PLANS)) {
    if (plan.priceId === priceId) {
      return planId as PlanId
    }
  }
  return null
}

// Helper to get credit pack by price ID
export function getCreditPackByPriceId(priceId: string): CreditPackId | null {
  for (const [packId, pack] of Object.entries(CREDIT_PACKS)) {
    if (pack.priceId === priceId) {
      return packId as CreditPackId
    }
  }
  return null
}
```

Update `.env.example` to add Stripe environment variables:
```
# Stripe - Get from https://dashboard.stripe.com/apikeys
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Stripe Price IDs - Create products in Stripe Dashboard
# Test mode: https://dashboard.stripe.com/test/products
# Live mode: https://dashboard.stripe.com/products
STRIPE_PRICE_STARTER=price_...
STRIPE_PRICE_PROFESSIONAL=price_...
STRIPE_PRICE_CREDITS_5=price_...
STRIPE_PRICE_CREDITS_10=price_...
STRIPE_PRICE_CREDITS_25=price_...
```

Note: Do NOT use hardcoded apiVersion string if it causes issues. Check Stripe SDK docs for correct format.
  </action>
  <verify>
1. `npx tsc --noEmit` passes without errors
2. Files exist at lib/stripe/client.ts and lib/stripe/config.ts
3. .env.example contains STRIPE_* variables
  </verify>
  <done>Stripe client exports `stripe` instance, config exports PLANS and CREDIT_PACKS with type-safe helpers</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds (Stripe imports resolve)
- TypeScript compilation passes
- No runtime errors importing stripe client (will fail if env var missing, which is correct)
</verification>

<success_criteria>
1. Stripe packages installed in package.json
2. lib/stripe/client.ts exports initialized Stripe instance
3. lib/stripe/config.ts exports PLANS, CREDIT_PACKS, and helper functions
4. .env.example documents all required Stripe environment variables
5. TypeScript types are correct for all exports
</success_criteria>

<output>
After completion, create `.planning/phases/03-subscription-and-credits/03-01-SUMMARY.md`
</output>
