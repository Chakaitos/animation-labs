---
phase: 03-subscription-and-credits
plan: 05
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - app/(protected)/billing/page.tsx
  - components/CreditPackCard.tsx
  - components/CreditHistory.tsx
autonomous: true

must_haves:
  truths:
    - "User can view current subscription details"
    - "User can access Stripe Customer Portal"
    - "User can view available credit packs"
    - "User can purchase credit packs"
    - "User can view credit transaction history"
  artifacts:
    - path: "app/(protected)/billing/page.tsx"
      provides: "Billing management page"
      min_lines: 80
    - path: "components/CreditPackCard.tsx"
      provides: "Credit pack purchase card"
      min_lines: 25
    - path: "components/CreditHistory.tsx"
      provides: "Credit transaction history list"
      min_lines: 30
  key_links:
    - from: "app/(protected)/billing/page.tsx"
      to: "createPortalSession"
      via: "form action"
      pattern: "action.*createPortalSession"
    - from: "components/CreditPackCard.tsx"
      to: "createCreditPackCheckout"
      via: "form action"
      pattern: "createCreditPackCheckout"
---

<objective>
Create billing page with subscription details, portal access, credit packs, and transaction history

Purpose: Enable users to manage their subscription and purchase additional credits
Output: Full billing page with all subscription management features
</objective>

<execution_context>
@/Users/chakaitos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chakaitos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-subscription-and-credits/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credit pack and history components</name>
  <files>components/CreditPackCard.tsx, components/CreditHistory.tsx</files>
  <action>
Create `components/CreditPackCard.tsx`:
```typescript
'use client'

import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Coins } from 'lucide-react'
import { useTransition } from 'react'
import { toast } from 'sonner'
import { createCreditPackCheckout } from '@/lib/actions/checkout'
import type { CreditPackId } from '@/lib/stripe/config'

interface CreditPackCardProps {
  packId: CreditPackId
  name: string
  credits: number
  price: string
}

export function CreditPackCard({ packId, name, credits, price }: CreditPackCardProps) {
  const [isPending, startTransition] = useTransition()

  const handlePurchase = () => {
    startTransition(async () => {
      const result = await createCreditPackCheckout(packId)
      if (result?.error) {
        toast.error(result.error)
      }
      // Redirect happens in the action
    })
  }

  return (
    <Card>
      <CardHeader className="pb-2">
        <CardTitle className="text-lg flex items-center gap-2">
          <Coins className="h-5 w-5 text-primary" />
          {name}
        </CardTitle>
      </CardHeader>
      <CardContent>
        <div className="mb-4">
          <span className="text-2xl font-bold">{price}</span>
        </div>
        <Button
          className="w-full"
          variant="outline"
          onClick={handlePurchase}
          disabled={isPending}
        >
          {isPending ? 'Redirecting...' : 'Purchase'}
        </Button>
      </CardContent>
    </Card>
  )
}
```

Create `components/CreditHistory.tsx`:
```typescript
import { getCreditHistory } from '@/lib/actions/billing'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { formatDistanceToNow } from 'date-fns'

interface CreditHistoryProps {
  className?: string
}

export async function CreditHistory({ className }: CreditHistoryProps) {
  const result = await getCreditHistory(10)

  if (result.error) {
    return (
      <Card className={className}>
        <CardHeader>
          <CardTitle>Credit History</CardTitle>
          <CardDescription>Unable to load transaction history</CardDescription>
        </CardHeader>
      </Card>
    )
  }

  const { transactions } = result

  if (!transactions || transactions.length === 0) {
    return (
      <Card className={className}>
        <CardHeader>
          <CardTitle>Credit History</CardTitle>
          <CardDescription>No transactions yet</CardDescription>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-muted-foreground">
            Your credit transactions will appear here.
          </p>
        </CardContent>
      </Card>
    )
  }

  return (
    <Card className={className}>
      <CardHeader>
        <CardTitle>Credit History</CardTitle>
        <CardDescription>Recent credit transactions</CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {transactions.map((tx) => (
            <div key={tx.id} className="flex items-center justify-between">
              <div className="flex-1 min-w-0">
                <p className="text-sm font-medium truncate">{tx.description}</p>
                <p className="text-xs text-muted-foreground">
                  {formatDistanceToNow(new Date(tx.created_at), { addSuffix: true })}
                </p>
              </div>
              <div className="flex items-center gap-2">
                <Badge variant={tx.amount > 0 ? 'default' : 'secondary'}>
                  {tx.type}
                </Badge>
                <span className={`text-sm font-medium ${tx.amount > 0 ? 'text-green-600' : 'text-muted-foreground'}`}>
                  {tx.amount > 0 ? '+' : ''}{tx.amount}
                </span>
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  )
}
```

Note: Install date-fns if not already installed: `npm install date-fns`
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Files exist at components/CreditPackCard.tsx and components/CreditHistory.tsx
  </verify>
  <done>Credit pack purchase card and transaction history components created</done>
</task>

<task type="auto">
  <name>Task 2: Create billing page</name>
  <files>app/(protected)/billing/page.tsx</files>
  <action>
Create `app/(protected)/billing/page.tsx`:
```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import Link from 'next/link'
import Image from 'next/image'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { UserMenu } from '@/components/UserMenu'
import { CreditPackCard } from '@/components/CreditPackCard'
import { CreditHistory } from '@/components/CreditHistory'
import { CreditBalance } from '@/components/CreditBalance'
import { PLANS, CREDIT_PACKS, type PlanId, type CreditPackId } from '@/lib/stripe/config'
import { createPortalSession, getSubscription } from '@/lib/actions/billing'
import { ArrowLeft, ExternalLink, Calendar, AlertCircle } from 'lucide-react'
import { format } from 'date-fns'

// Credit pack pricing (displayed only - actual prices from Stripe)
const PACK_PRICES: Record<CreditPackId, string> = {
  small: '$9',
  medium: '$15',
  large: '$35',
}

export default async function BillingPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login?next=/billing')
  }

  const result = await getSubscription()
  const subscription = result.subscription

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <header className="border-b">
        <div className="container mx-auto px-4 py-4 flex items-center justify-between">
          <Link href="/dashboard" className="flex items-center gap-2">
            <Image src="/logo.svg" alt="AnimateLabs" width={120} height={32} />
          </Link>
          <UserMenu user={user} />
        </div>
      </header>

      {/* Main Content */}
      <main className="container mx-auto px-4 py-8 max-w-4xl">
        <div className="flex items-center gap-4 mb-8">
          <Button variant="ghost" size="icon" asChild>
            <Link href="/dashboard">
              <ArrowLeft className="h-4 w-4" />
            </Link>
          </Button>
          <div>
            <h1 className="text-2xl font-bold">Billing</h1>
            <p className="text-muted-foreground">Manage your subscription and credits</p>
          </div>
        </div>

        {/* No Subscription State */}
        {!subscription && (
          <Card className="mb-8">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <AlertCircle className="h-5 w-5 text-yellow-500" />
                No Active Subscription
              </CardTitle>
              <CardDescription>
                Subscribe to a plan to start creating logo animations.
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Button asChild>
                <Link href="/subscribe">View Plans</Link>
              </Button>
            </CardContent>
          </Card>
        )}

        {/* Current Subscription */}
        {subscription && (
          <div className="grid gap-6 md:grid-cols-2 mb-8">
            {/* Plan Details */}
            <Card>
              <CardHeader>
                <CardTitle>Current Plan</CardTitle>
                <CardDescription>Your subscription details</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center justify-between">
                  <span className="text-muted-foreground">Plan</span>
                  <span className="font-semibold">{subscription.planName}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-muted-foreground">Status</span>
                  <Badge variant={subscription.status === 'active' ? 'default' : 'destructive'}>
                    {subscription.status}
                  </Badge>
                </div>
                {subscription.currentPeriodEnd && (
                  <div className="flex items-center justify-between">
                    <span className="text-muted-foreground">Renews</span>
                    <span className="flex items-center gap-1">
                      <Calendar className="h-4 w-4" />
                      {format(new Date(subscription.currentPeriodEnd), 'MMM d, yyyy')}
                    </span>
                  </div>
                )}
                <div className="pt-4 border-t">
                  <form action={createPortalSession}>
                    <Button type="submit" variant="outline" className="w-full">
                      Manage Subscription
                      <ExternalLink className="h-4 w-4 ml-2" />
                    </Button>
                  </form>
                  <p className="text-xs text-muted-foreground mt-2 text-center">
                    Update payment method, change plan, or cancel
                  </p>
                </div>
              </CardContent>
            </Card>

            {/* Credit Balance */}
            <div className="space-y-4">
              <CreditBalance />
              <Card>
                <CardContent className="pt-6">
                  <Button variant="outline" className="w-full" asChild>
                    <Link href="/subscribe">
                      {subscription.plan === 'starter' ? 'Upgrade to Professional' : 'Change Plan'}
                    </Link>
                  </Button>
                </CardContent>
              </Card>
            </div>
          </div>
        )}

        {/* Credit Packs */}
        {subscription && subscription.status === 'active' && (
          <div className="mb-8">
            <h2 className="text-lg font-semibold mb-4">Buy More Credits</h2>
            <p className="text-sm text-muted-foreground mb-4">
              Need more credits this month? Purchase a credit pack. These credits don&apos;t expire and carry over between billing periods.
            </p>
            <div className="grid gap-4 sm:grid-cols-3">
              {(Object.entries(CREDIT_PACKS) as [CreditPackId, typeof CREDIT_PACKS.small][]).map(([packId, pack]) => (
                <CreditPackCard
                  key={packId}
                  packId={packId}
                  name={pack.name}
                  credits={pack.credits}
                  price={PACK_PRICES[packId]}
                />
              ))}
            </div>
          </div>
        )}

        {/* Credit History */}
        {subscription && <CreditHistory />}
      </main>
    </div>
  )
}
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. File exists at app/(protected)/billing/page.tsx
  </verify>
  <done>Billing page displays subscription details, portal access, credit packs, and transaction history</done>
</task>

<task type="auto">
  <name>Task 3: Install date-fns dependency</name>
  <files>package.json</files>
  <action>
Install date-fns for date formatting:
```bash
npm install date-fns
```

This package is used for:
- formatDistanceToNow (e.g., "2 hours ago") in CreditHistory
- format (e.g., "Jan 15, 2026") in billing page for renewal date
  </action>
  <verify>
Run `npm ls date-fns` - package shows installed with version number.
  </verify>
  <done>date-fns installed for date formatting in billing components</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- Billing page renders with all sections
- TypeScript compilation passes
- date-fns is installed
</verification>

<success_criteria>
1. Billing page shows subscription details (plan, status, renewal date)
2. "Manage Subscription" button opens Stripe Customer Portal
3. Credit packs displayed for active subscribers
4. Clicking credit pack redirects to Stripe Checkout
5. Credit history shows recent transactions
6. Users without subscription see "Subscribe" CTA
7. All date formatting works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-subscription-and-credits/03-05-SUMMARY.md`
</output>
